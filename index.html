
<!DOCTYPE html>
<!-- Download: sandbox:/mnt/data/gcse_number_foundation_split_02_N4-N6_REVISED_v8.html -->
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GCSE Maths (Foundation) — Number Topic Preview (N4–N6)</title>
<style>
  /* SECTION: Styles
     - Layout + typography
     - Question card UI
     - Input widgets (including drag-and-drop ordering and standard form EXP entry)
     NOTE: Keep classnames/IDs stable: the JS relies on many of them.
  */
  :root{
    --ink:#0f172a; --muted:#6b7280; --accent:#2563eb; --bg:#ffffff; --border:#e5e7eb;
    --green:#16a34a; --orange:#f59e0b; --red:#dc2626;
    --fbar:1px; /* ultra-thin fraction bar */
  }

  html,body{
    margin:0;padding:0;background:var(--bg);color:var(--ink);
    font:19px/1.65 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
  }

  header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border)}
  main{max-width:1040px;margin:1.2rem auto 4rem;padding:0 1rem}

  /* top control bar (simple, no tabs) */
  .bar{
    display:flex;gap:.65rem;align-items:center;flex-wrap:wrap;
    padding:.75rem .9rem
  }
  .bar .group{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .bar label{font-weight:900;color:#111827;font-size:1rem}
  select, input[type="text"], input[type="number"]{
    padding:.55rem .65rem;border:1px solid var(--border);border-radius:.6rem;min-width:160px;
    background:#fff;color:var(--ink);font-size:1rem
  }
  input[type="text"], input[type="number"]{min-width:160px}
  .primary{
    background:var(--accent);color:#fff;border:1px solid var(--accent);
    border-radius:.65rem;padding:.6rem 1.05rem;cursor:pointer;font-weight:900;font-size:1rem
  }
  .ghost{
    background:#fff;color:var(--ink);border:1px solid var(--border);
    border-radius:.65rem;padding:.6rem 1.05rem;cursor:pointer;font-weight:900;font-size:1rem
  }
  .muted{color:var(--muted);font-size:1rem}
  .spacer{flex:1}
  .actions{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}

  /* question panel */
  .qpanel{border:1px solid var(--border);border-radius:1rem;overflow:hidden;margin-top:1rem;
    box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .qhead{
    padding:1rem 1.05rem;border-bottom:1px solid var(--border);
    background:linear-gradient(180deg,#fbfdff,#f8fafc);
    display:flex;align-items:center;justify-content:space-between;gap:.7rem;flex-wrap:wrap
  }
  .qhead h3{margin:.1rem 0;font-size:1.2rem}
  .qbody{padding:1.1rem 1.05rem}
  .badge{display:inline-block;margin-left:.55rem;padding:.08rem .5rem;border:1px solid var(--border);
    border-radius:8px;background:#eef2ff;font-size:.95rem}
  .nc-tag{font-weight:900;text-transform:uppercase;letter-spacing:.02em;font-size:.95rem}
  .nc{color:#15803d}
  .calc{color:#1d4ed8}

  /* question lines */
  .item{padding:.6rem .1rem;border-bottom:1px dashed rgba(229,231,235,.9)}
  .item:last-child{border-bottom:none}
  .line{
    display:flex;align-items:flex-start;gap:.75rem;flex-wrap:wrap;
  }
  .qtext{flex:1;min-width:280px}
  .endmark{margin-left:.4rem;font-weight:900;color:#334155}

  .hlDigit{background:rgba(245,158,11,.25);border:1px solid rgba(245,158,11,.45);border-radius:.25rem;padding:0 .2rem;box-decoration-break:clone;-webkit-box-decoration-break:clone;}
  .sfhint{font-size:.85rem;color:#64748b;margin-top:.35rem;max-width:520px}

  /* inputs - feedback highlighting */
  .ok{outline:2px solid rgba(22,163,74,.35); border-color:rgba(22,163,74,.55)!important}
  .bad{outline:2px solid rgba(220,38,38,.28); border-color:rgba(220,38,38,.55)!important}

  /* fraction widget */
  .frac{display:inline-grid;grid-template-rows:auto 0 auto;row-gap:0;align-items:center;justify-items:center;line-height:0;vertical-align:middle}
  .frac input{
    width:92px;text-align:center;border:1px solid var(--border);border-radius:.45rem;padding:.45rem .5rem;margin:0;
    appearance:textfield;font-size:1rem;min-width:0
  }
  .frac input::-webkit-outer-spin-button,.frac input::-webkit-inner-spin-button{appearance:none;margin:0}
  .frac .bar{width:92px;height:0;border-top:var(--fbar) solid #111;margin:16px 0 0 0}
  .frac input:last-child{margin-top:-2px}

  /* pair/triple widgets */
  .twobox, .threebox, .sfbox{
    display:inline-flex;gap:.5rem;align-items:center;flex-wrap:wrap
  }
  .twobox input, .threebox input, .sfbox input{
    min-width:120px
  }
  .mini{min-width:110px!important}
  .tiny{min-width:90px!important}


  /* standard form input (no ^) */
  .sfTen{font-weight:900}
  .sfexp{
    vertical-align:super;
    font-size:.85rem;
    min-width:72px!important;
    width:72px;
    padding:.22rem .3rem;
  }

  /* prime factorisation input (EXP toggles superscripts) */
  .pfbox{
    min-height:44px;
    border:1px solid var(--border);
    border-radius:.55rem;
    padding:.45rem .55rem;
    background:#fff;
    font-weight:850;
    letter-spacing:.01em;
    line-height:1.2;
  }
  .pfbox sup{font-size:.75em;vertical-align:super}
  .pfbox .mul{opacity:.9;padding:0 .12rem}
  .kbtn.on{
    background:#2563eb;
    border-color:#2563eb;
    color:#fff;
  }

  /* prime factors keypad */
  .pfwrap{display:flex;flex-direction:column;gap:.5rem;min-width:320px}
  .keypad{display:flex;gap:.45rem;flex-wrap:wrap}
  .kbtn{
    border:1px solid var(--border);background:#fff;border-radius:.6rem;
    padding:.4rem .7rem;cursor:pointer;font-weight:900;font-size:1rem
  }
  .kbtn:active{transform:translateY(1px)}
  .kbtn.accent{border-color:rgba(37,99,235,.35);background:#eef2ff}

  /* feedback */
  .feedback{margin-top:1rem;border:1px solid var(--border);border-radius:.75rem;padding:.85rem 1rem;background:#f8fafc}
  .feedback.good{background:#ecfdf5;border-color:rgba(22,163,74,.22);color:#065f46}
  .feedback.bad{background:#fef2f2;border-color:rgba(220,38,38,.22);color:#7f1d1d}

  .mathwrap{display:inline-block;vertical-align:middle}

  /* -------------------- drag ordering widget -------------------- */
  .drag-order{
    margin:.6rem 0 .1rem 0;
    padding:.6rem .65rem;
    border:1px solid var(--border);
    border-radius:1rem;
    background:linear-gradient(180deg,#ffffff,#f8fafc);
  }
  .drag-bank, .drag-targets{
    display:flex;
    gap:.5rem;
    flex-wrap:wrap;
    align-items:center;
  }
  .drag-bank{
    padding:.5rem;
    border:1px solid var(--border);
    border-radius:.85rem;
    background:#fff;
  }
  .drag-targets{
    margin-top:.55rem;
    padding:.5rem;
    border:1px dashed rgba(107,114,128,.35);
    border-radius:.85rem;
    background:#f8fafc;
    min-height:56px;
  }
  .dragbox{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:.35rem .65rem;
    border:1px solid var(--border);
    border-radius:.7rem;
    background:#fff;
    cursor:grab;
    font-weight:900;
    user-select:none;
    -webkit-user-select:none;
    touch-action:manipulation;
  }
  .dragbox:active{ cursor:grabbing; }
  .dragbox.dragging{ opacity:.55; }
  .dragbox.selected{
    outline:2px solid rgba(37,99,235,.45);
    border-color:rgba(37,99,235,.55);
  }
  .dropbox{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:92px;
    min-height:46px;
    padding:.2rem .35rem;
    border:2px dashed rgba(229,231,235,.95);
    border-radius:.7rem;
    background:#fff;
  }
  .dropbox.over{
    border-color:rgba(37,99,235,.65);
    background:#eff6ff;
  }
  .dropbox .dragbox{ cursor:grab; }

  .drag-instr{
    margin-top:.45rem;
    color:var(--muted);
    font-size:1rem;
  }

  .dragbox math{ font-size:1.05em; }

  /* -------------------- standard form (single box + EXP keypad) -------------------- */
  .sfwrap{
    display:flex;
    flex-direction:column;
    gap:.55rem;
    min-width:320px;
  }
  .sfinput{
    padding:.55rem .65rem;
    border:1px solid var(--border);
    border-radius:.6rem;
    background:#fff;
    color:var(--ink);
    font-size:1rem;
    min-width:240px;
  }
  .sfhint{
    color:var(--muted);
    font-size:1rem;
  }

  @media (max-width:560px){
    .dropbox{ min-width:78px; }
    .sfwrap{ min-width:260px; }
  }

</style>
</head>
<body>

<header>
  <div class="bar">
    <div class="group">
      <label for="topicSel">Topic</label>
      <select id="topicSel"></select>
    </div>

    <div class="group">
      <label for="marksSel">Marks</label>
      <select id="marksSel">
        <option value="1">1 mark</option>
        <option value="2">2 marks</option>
        <option value="3">3 marks</option>
        <option value="4">4 marks</option>
        <option value="5">5 marks</option>
      </select>
    </div>

    <div class="group">
      <label for="calcSel">Paper</label>
      <select id="calcSel">
        <option value="noncalc">Non-calculator</option>
        <option value="calc">Calculator</option>
      </select>
    </div>

    <div class="spacer"></div>

    <div class="actions">
      <button class="primary" id="regenBtn" type="button">Regenerate numbers</button>
      <button class="ghost" id="checkBtn" type="button">Check</button>
      <button class="ghost" id="revealBtn" type="button">Reveal answers</button>
    </div>
  </div>
</header>

<main>
  <section id="preview"></section>
  <div class="feedback" id="fb" style="display:none"></div>
</main>

<script>
/* ============================================================
   GCSE (Foundation) Number Question Preview Tool (N1–N50)
   - NO ratio topics.
   - NO recurring decimals.
   - Finer-grained topics (each N code is a single narrow topic).
   - Marks selector gives a question that is worth those marks:
       higher marks => more steps / more answer boxes / more structure,
       not just “same question with bigger numbers”.
   - Calculator mode uses calculator-suitable numbers (messier decimals, awkward divisions),
     and where needed asks for answers to 2 decimal places.
   ============================================================ */

// SECTION: File map (searchable)
// - SECTION: Seeded RNG
// - SECTION: Formatting helpers (MathML, standard form parsing)
// - SECTION: Topic list / navigation (TOPICS)
// - SECTION: Scenario variants (contextVariants)
// - SECTION: Question parts (partInteger/partNumber/...)
// - SECTION: Build question card (buildQuestion switch by topic code)
// - SECTION: Rendering + interaction (tabs, check/reveal, drag ordering)
// EDIT HERE: Most question content is generated in buildQuestion(topicCode, marksTotal, rng).

// SECTION: Seeded RNG (deterministic per regeneration seed)
function hashToUint32(str){
  let h = 2166136261 >>> 0;
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function cryptoSeed(){
  if (window.crypto && crypto.getRandomValues){
    const a = new Uint32Array(1);
    crypto.getRandomValues(a);
    return a[0] >>> 0;
  }
  return (Math.random()*2**32)>>>0;
}
function mulberry32(seed){
  let t = seed >>> 0;
  return function(){
    t += 0x6D2B79F5;
    let x = t;
    x = Math.imul(x ^ (x >>> 15), x | 1);
    x ^= x + Math.imul(x ^ (x >>> 7), x | 61);
    return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
  };
}
function makeRng(seedLike){
  const seed = (seedLike===undefined || seedLike===null || seedLike==="")
    ? cryptoSeed()
    : (typeof seedLike==="number" ? (seedLike>>>0) : hashToUint32(String(seedLike)));
  const r = mulberry32(seed);
  return {
    seed,
    float: ()=>r(),
    int: (min,max)=>{
      min=Math.ceil(min); max=Math.floor(max);
      return Math.floor(r()*(max-min+1))+min;
    },
    choice: (arr)=>arr[Math.floor(r()*arr.length)],
    shuffle: (arr)=>{
      const a=arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(r()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }
  };
}

/* -------------------- helpers -------------------- */
function gcd(a,b){a=Math.abs(a);b=Math.abs(b);while(b){[a,b]=[b,a%b]}return a||1}
function lcm(a,b){ return Math.abs(a*b)/gcd(a,b); }
function roundTo(x, dp){
  const f = 10**dp;
  return Math.round((+x + Number.EPSILON)*f)/f;
}
function fmt(x, maxDp=6){
  const n = Number(x);
  if(!Number.isFinite(n)) return String(x);
  const s = n.toFixed(maxDp);
  return s.replace(/\.?0+$/,"");
}
function simpFrac(n,d){
  if(d===0) return {n:NaN,d:NaN};
  if(d<0){n=-n;d=-d}
  const g=gcd(n,d);
  return {n:n/g,d:d/g};
}
function fracEq(a,b){
  const x=simpFrac(a.n,a.d), y=simpFrac(b.n,b.d);
  return x.n===y.n && x.d===y.d;
}
function asNum(v){
  const s = String(v??"").trim().replace(/,/g,"");
  if(!s) return NaN;
  // allow fraction "a/b" in numeric fields
  if(s.includes("/")){
    const m = s.match(/^(-?\d+)\s*\/\s*(-?\d+)$/);
    if(!m) return NaN;
    const n=Number(m[1]), d=Number(m[2]);
    if(!Number.isFinite(n)||!Number.isFinite(d)||d===0) return NaN;
    return n/d;
  }
  // allow leading +, decimals
  const x = Number(s);
  return Number.isFinite(x) ? x : NaN;
}
function close(a,b,tol=1e-8){ return Math.abs(a-b) <= tol; }

function parseStandardFormInput(raw){
  // Accept forms like:
  // 3.2×10⁵   3.2x10^5   3.2E5   3.2×10-5  (Unicode superscripts supported)
  const s0 = String(raw ?? "").trim();
  if(!s0) return null;

  // Normalise
  let s = s0.replace(/\s+/g,"");
  s = s.replace(/×/g,"x").replace(/⋅/g,"x").replace(/·/g,"x");
  s = s.replace(/EXP/ig,"E");
  s = s.replace(/[−–—]/g,"-"); // unicode minus/dashes

  // Convert Unicode superscripts to normal digits/sign
  const supMap = {"⁰":"0","¹":"1","²":"2","³":"3","⁴":"4","⁵":"5","⁶":"6","⁷":"7","⁸":"8","⁹":"9","⁻":"-","⁺":"+"};
  s = s.replace(/[⁰¹²³⁴⁵⁶⁷⁸⁹⁻⁺]/g, ch => supMap[ch] ?? ch);

  // Standardise multiply symbol
  s = s.replace(/X/g,"x");

  // Pattern A: mantissa E exponent
  let m = s.match(/^([+-]?\d*\.?\d+)E([+-]?\d+)$/i);
  if(m){
    const mantissa = Number(m[1]);
    const exp = parseInt(m[2],10);
    if(!Number.isFinite(mantissa) || !Number.isFinite(exp)) return null;
    return {mantissa, exp, value: mantissa * Math.pow(10, exp)};
  }

  // Pattern B: mantissa × 10 ^ exponent  (caret optional, exponent may follow immediately after 10)
  m = s.match(/^([+-]?\d*\.?\d+)(?:x|\*)10\^?([+-]?\d+)$/i);
  if(m){
    const mantissa = Number(m[1]);
    const exp = parseInt(m[2],10);
    if(!Number.isFinite(mantissa) || !Number.isFinite(exp)) return null;
    return {mantissa, exp, value: mantissa * Math.pow(10, exp)};
  }

  return null;
}


/* -------------------- MathML helpers -------------------- */
const MNS = `http://www.w3.org/1998/Math/MathML`;
function mfrac(n,d){
  return `<span class="mathwrap"><math xmlns="${MNS}" display="inline"><mfrac><mn>${n}</mn><mn>${d}</mn></mfrac></math></span>`;
}
function msup(base, exp){
  const baseNode = Number.isFinite(+base) ? `<mn>${base}</mn>` : `<mi>${String(base)}</mi>`;
  return `<span class="mathwrap"><math xmlns="${MNS}" display="inline"><msup>${baseNode}<mn>${exp}</mn></msup></math></span>`;
}

// SECTION: Topic list / tab navigation
// EDIT HERE: To add/remove topics or change the tab label, edit the TOPICS array below.
// NOTE: Each `code` must have a corresponding `case "CODE"` in the buildQuestion() switch.
/* SPLITMERGE:TOPICS-START */
const TOPICS = [
  {code:"N4",  name:"Place value & powers of 10"},
  {code:"N5",  name:"Addition (integers & decimals)"},
  {code:"N6",  name:"Subtraction (integers & decimals)"}
];
/* SPLITMERGE:TOPICS-END */

/* -------------------- number pickers -------------------- */
function pickDec(rng, dp){
  // dp digits after decimal, always non-trailing safe
  const m = 10**dp;
  return rng.int(1*m, 999*m)/m;
}
function pickMoney(rng, isCalc){
  // money prices: noncalc => 2 dp but friendly; calc => awkward 2 dp
  const pennies = isCalc ? rng.int(105, 2999) : rng.choice([125,150,175,200,225,250,275,300,350,400,450,500,550,600,650,700,750,800,900,1000,1200,1500]);
  return pennies/100;
}
function pickNiceInt(rng, min=2, max=40){ return rng.int(min, max); }
function pickBigInt(rng){ return rng.int(1200, 98000); }

function pickPercent(rng, allowOneDp=false){
  // GCSE-friendly percentages (no recurring). If allowOneDp, may return values like 12.5 or 7.5.
  const ints = [1,2,3,4,5,6,8,10,12,15,18,20,25,30,35,40,45,50,60,75,80,90];
  const oneDp = [2.5,7.5,12.5,17.5,22.5,37.5,62.5];
  return allowOneDp ? rng.choice(ints.concat(oneDp)) : rng.choice(ints);
}

/* -------------------- part constructors -------------------- */
function partNumber(id, textHtml, marks, value){
  return {marks, textHtml, input:{kind:"number", id}, answer:{type:"number", value}};
}
function partInteger(id, textHtml, marks, value){
  return {marks, textHtml, input:{kind:"integer", id}, answer:{type:"number", value}};
}
function partFraction(id, textHtml, marks, frac){
  return {marks, textHtml, input:{kind:"fraction", id}, answer:{type:"fraction", value: frac}};
}
function partPair(id, textHtml, marks, pair, opts={}){
  return {marks, textHtml, input:{kind:(opts.kind||"pair"), id, placeholders:opts.placeholders, labels:opts.labels}, answer:{type:"pair", value: pair}};
}
function partStdForm(id, textHtml, marks, val, nMaybe){
  // val can be:
  //  - the actual numeric value to be written in standard form, OR
  //  - (A, n) where val is A and nMaybe is the power of 10.
  const num = (typeof nMaybe !== "undefined")
    ? (Number(val) * (10**Number(nMaybe)))
    : Number(val);
  return {marks, textHtml, input:{kind:"standardForm", id}, answer:{type:"standardForm", value: num}};
}
function partOrder(id, textHtml, marks, correctTokens){
  return {marks, textHtml, input:{kind:"order", id}, answer:{type:"order", value: correctTokens}};
}
function partPrimeFactors(id, textHtml, marks, primeMap){
  // primeMap: {2:3, 3:1, ...}
  return {marks, textHtml, input:{kind:"primeFactors", id}, answer:{type:"primeFactors", value: primeMap}};
}
function partMoney(id, textHtml, marks, value){
  return {marks, textHtml, input:{kind:"money", id}, answer:{type:"number", value}};
}

function partSymbol(id, textHtml, marks, value){
  return {marks, textHtml, input:{kind:"symbol", id}, answer:{type:"symbol", value}};
}

/* -------------------- prime factor helpers -------------------- */
function factorise(n){
  // returns map {p:exp}, n is integer >=2
  let x = Math.abs(Math.trunc(n));
  const map = {};
  let p = 2;
  while(p*p <= x){
    while(x % p === 0){
      map[p] = (map[p]||0) + 1;
      x = Math.trunc(x/p);
    }
    p = (p===2) ? 3 : p+2;
  }
  if(x>1) map[x] = (map[x]||0)+1;
  return map;
}
function mapsEqual(a,b){
  const ka = Object.keys(a).sort();
  const kb = Object.keys(b).sort();
  if(ka.length!==kb.length) return false;
  for(let i=0;i<ka.length;i++){
    if(ka[i]!==kb[i]) return false;
    if(a[ka[i]]!==b[kb[i]]) return false;
  }
  return true;
}

// SECTION: Build one question card (topic + mark band)
// EDIT HERE: Each topic's question generator lives inside the switch(topicCode) below.
// - Adjust wording/values/answer keys within a topic `case`.
// - Keep IDs/classnames stable (the UI + checking logic rely on them).
// - To add a new topic, add it to TOPICS and add a matching case in this switch.
function buildQuestion(topicCode, marksTotal, paperMode, rng){
  const isCalc = paperMode === "calc";

  // SECTION: Scenario/context variants (3+ marks only)
  // These are injected directly into the student-facing prompt text (no separate context label above the question).
  // CHANGE REQUESTS #5/#6: N5 and N11 contexts are now specific and randomly selected.
    // SECTION: Scenario/context variants (4–5 marks only)
  // CHANGE: Scenarios are only shown for 4– and 5‑mark questions.
  // NOTE: Keep scenarios generic and avoid money as the default.
  const contextVariants = (code)=>{
    switch(code){
      case "N4":
        return [
          "A digital display shows a measurement reading.",
          "A device shows a distance reading.",
          "A meter shows a reading that needs converting to a different unit."
        ];
      case "N5":
        return [
          "A temperature changes during the day.",
          "A team’s score changes during a match.",
          "A bank account balance changes with deposits and withdrawals.",
          "A shop receipt lists several items.",
          "A packing list shows the masses of several items."
        ];
      case "N6":
        return [
          "A temperature drops in stages.",
          "A phone’s battery percentage decreases after two uses.",
          "A tank level decreases as water is used.",
          "A gift card balance is used to buy several items.",
          "A data allowance decreases as apps use data."
        ];
      default:
        return [
          "A student is using numbers from an everyday situation.",
          "Someone is using numbers to complete a practical task.",
          "A real-life problem requires interpreting numbers accurately."
        ];
    }
  };

  // helper: create object
  // SECTION: Scenario/context (4–5 marks only)
  // CHANGE: Scenarios are shown ONLY for 4– and 5‑mark questions.
  //         They appear as an intro paragraph ABOVE the sub‑questions so answer boxes stay aligned
  //         with each sub‑question line (no “top‑right” floating inputs).
  function pickContextLead(){
    const leads = contextVariants(topicCode) || [];
    if(leads.length === 0) return "";
    // CHANGE: If extra scenario types are available (e.g. item lists), weight the choices:
    // - Prefer the first two most-generic contexts.
    // - Use money-related contexts less often.
    if(leads.length >= 5){
      const r = rng.float();
      if(r < 0.60) return rng.choice(leads.slice(0,2));
      if(r < 0.75) return leads[2];
      return rng.choice(leads.slice(3));
    }
    if(leads.length >= 3){
      return (rng.float() < 0.8) ? rng.choice(leads.slice(0,2)) : leads[2];
    }
    return rng.choice(leads);
  }

  const Q = (parts, contextHtml="")=>{
    // CHANGE: Only attach context for 4+ mark questions (requested).
    const ctx = (marksTotal >= 4) ? (contextHtml || "") : "";
    return {topicCode, marksTotal, paperMode, parts, contextHtml: ctx};
  };

  // helper: "calc style" rounding to 2 dp for awkward results
  const need2dp = isCalc; // calculator questions will often say 2 d.p.

  switch(topicCode){
    /* SPLITMERGE:BUILDQUESTION-CASES-START */
    /* ===================== N4 Place value & powers of 10 ===================== */
    case "N4": {
      // Helpers: build numbers with/without decimals (no unnecessary trailing zeros)
      // CHANGE: Calculator (2–3 marks) uses larger powers of 10 (10,000 to 1,000,000).
      const factorsMulDiv = isCalc ? [10000, 100000, 1000000] : [10, 100, 1000];
      const pickFactorMulDiv = ()=> rng.choice(factorsMulDiv);

      const makeDecString = (maxInt=9999, maxDp=3)=>{
        const intPart = rng.int(10, maxInt);
        // 70% chance of decimals
        const useDec = (rng.float() < 0.7);
        if(!useDec) return String(intPart);
        const dp = rng.int(1, maxDp);
        let digs = "";
        for(let i=0;i<dp-1;i++) digs += String(rng.int(0,9));
        digs += String(rng.int(1,9)); // last digit non-zero => no trailing zeros
        return `${intPart}.${digs}`;
      };

      const makeWholeInt = (min=1000, max=999999)=>{
        return rng.int(min, max);
      };

      const pvFromString = (s, idx)=>{
        const dot = s.indexOf(".");
        const dp = (dot === -1) ? s.length : dot;
        if(idx < dp){
          const power = (dp - 1) - idx; // ones=0, tens=1, ...
          return Math.pow(10, power);
        } else {
          const places = idx - dp; // tenths=1, hundredths=2...
          return Math.pow(10, -places);
        }
      };

      const pickHighlight = (s)=>{
        const pos = [];
        for(let i=0;i<s.length;i++){
          if(s[i] !== ".") pos.push(i);
        }
        // Prefer a non‑zero digit
        for(let tries=0; tries<20; tries++){
          const idx = rng.choice(pos);
          if(s[idx] !== "0") return idx;
        }
        return rng.choice(pos);
      };

      const makeHighlighted = (s)=>{
        const idx = pickHighlight(s);
        const digit = parseInt(s[idx], 10);
        const place = pvFromString(s, idx);
        const value = roundTo(digit * place, 12);
        const html = s.slice(0, idx) + `<span class="hlDigit">${s[idx]}</span>` + s.slice(idx+1);
        return {s, html, idx, digit, place, value};
      };

      const pow10exp = (n)=>{
        // n is a power of 10 (e.g. 10, 1000, 1000000)
        let e = 0;
        let x = Number(n);
        while(x > 1){
          x = x / 10;
          e++;
        }
        return e;
      };

      const shiftDecimalString = (numStr, places)=>{
        // Move the decimal point without floating-point rounding errors.
        // places > 0 => multiply by 10^places, places < 0 => divide by 10^(-places)
        let s = String(numStr ?? "").trim();
        if(!s) return "0";

        // sign
        let sign = "";
        if(s[0] === "-"){ sign = "-"; s = s.slice(1); }
        if(s[0] === "+"){ s = s.slice(1); }

        // split
        const parts = s.split(".");
        let intPart = parts[0] || "0";
        let fracPart = parts[1] || "";

        // tidy leading zeros in integer part (keep at least one digit)
        intPart = intPart.replace(/^0+(?=\d)/, "");
        if(intPart === "") intPart = "0";

        // digits only
        let digits = (intPart + fracPart);
        digits = digits.replace(/^0+(?=\d)/, "");
        if(digits === "") digits = "0";

        const dpPos = intPart.length;
        const newPos = dpPos + Number(places);

        let out = "";
        if(newPos <= 0){
          out = "0." + "0".repeat(-newPos) + digits;
        } else if(newPos >= digits.length){
          out = digits + "0".repeat(newPos - digits.length);
        } else {
          out = digits.slice(0, newPos) + "." + digits.slice(newPos);
        }

        // remove trailing zeros in fractional part + remove dot if not needed
        if(out.includes(".")){
          let [i,f] = out.split(".");
          i = i.replace(/^0+(?=\d)/, "");
          if(i === "") i = "0";
          f = f.replace(/0+$/, "");
          out = f ? (i + "." + f) : i;
        } else {
          out = out.replace(/^0+(?=\d)/, "");
          if(out === "") out = "0";
        }

        // avoid -0
        if(out === "0") sign = "";
        return sign + out;
      };

      const makeMulDiv = (op)=>{
        const factor = pickFactorMulDiv();
        const s = makeDecString(isCalc ? 99999 : 9999, isCalc ? 3 : 2);

        // exact decimal shift (factor is always a power of 10)
        const k = pow10exp(factor);
        const places = (op === "mul") ? k : -k;
        const resStr = shiftDecimalString(s, places);

        // Store as a string so Reveal answers shows a clean value (no 0.99999998 artefacts).
        return {s, factor, result: resStr};
      };

      if(marksTotal === 1){
        const n = makeHighlighted(makeDecString(isCalc ? 99999 : 9999, 3));
        return Q([
          partNumber(
            "n4_1",
            `In the number <b>${n.html}</b>, what is the <b>value</b> of the highlighted digit? <span class="endmark">[1]</span>`,
            1,
            n.value
          )
        ]);
      }

      if(marksTotal === 2){
        const a = makeHighlighted(makeDecString(isCalc ? 99999 : 9999, 3));
        const b = makeMulDiv("mul");
        return Q([
          partNumber(
            "n4_2a",
            `In the number <b>${a.html}</b>, what is the <b>value</b> of the highlighted digit? <span class="endmark">[1]</span>`,
            1,
            a.value
          ),
          partNumber(
            "n4_2b",
            `Work out <b>${b.s} × ${b.factor}</b>. <span class="endmark">[1]</span>`,
            1,
            b.result
          )
        ]);
      }

      if(marksTotal === 3){
        const a = makeHighlighted(makeDecString(isCalc ? 99999 : 9999, 3));
        let b = makeMulDiv("mul");
        let c = makeMulDiv("div");
        let guard = 0;
        while(c.factor === b.factor && guard < 20){
          c = makeMulDiv("div");
          guard++;
        }
        return Q([
          partNumber(
            "n4_3a",
            `In the number <b>${a.html}</b>, what is the <b>value</b> of the highlighted digit? <span class="endmark">[1]</span>`,
            1,
            a.value
          ),
          partNumber(
            "n4_3b",
            `Work out <b>${b.s} × ${b.factor}</b>. <span class="endmark">[1]</span>`,
            1,
            b.result
          ),
          partNumber(
            "n4_3c",
            `Work out <b>${c.s} ÷ ${c.factor}</b>. <span class="endmark">[1]</span>`,
            1,
            c.result
          )
        ]);
      }

      if(marksTotal === 4){
        // Scenario‑based (whole numbers only for digit-value-after-scaling steps)
        const lead = pickContextLead();
        const minStart = isCalc ? 20000 : 2000;
        const baseMaxStart = isCalc ? 999999 : 199999;

        const allowed4 = [10, 100, 1000, 10000];
        const limit4 = isCalc ? 9999999999 : 99999999;

        let mulF = 10, divF = 100, maxStart = baseMaxStart;
        for(let t=0; t<60; t++){
          mulF = rng.choice(allowed4);
          divF = rng.choice(allowed4.filter(x=>x!==mulF));
          const cap = Math.floor(limit4 / mulF);
          maxStart = Math.min(baseMaxStart, cap);
          if(maxStart >= minStart) break;
        }

        let startInt = makeWholeInt(minStart, maxStart);

        // Ensure the two-step scaling keeps the reading as a whole number.
        if(mulF < divF){
          const need = divF / mulF; // 10, 100 or 1000
          startInt = startInt - (startInt % need);
          if(startInt < minStart) startInt += need;
          if(startInt > maxStart) startInt -= need;
        }

        const n = makeHighlighted(String(startInt));

        const afterMul = startInt * mulF;
        const afterDiv = afterMul / divF;
        const digitAfter = roundTo(n.value * (mulF / divF), 12);

        const ctx =
          `${lead}<br>`+
          `A digital display shows the reading <b>${n.s}</b>.<br>`+
          `The reading is scaled by multiplying by <b>${mulF}</b>, then dividing by <b>${divF}</b>.`;

        return Q([
          partNumber(
            "n4_4a",
            `In the reading <b>${n.html}</b>, what is the <b>value</b> of the highlighted digit? <span class="endmark">[1]</span>`,
            1,
            n.value
          ),
          partNumber(
            "n4_4b",
            `Work out the reading after multiplying by <b>${mulF}</b>. <span class="endmark">[1]</span>`,
            1,
            afterMul
          ),
          partNumber(
            "n4_4c",
            `The reading is then divided by <b>${divF}</b>.<br>What is the new reading? <span class="endmark">[1]</span>`,
            1,
            afterDiv
          ),
          partNumber(
            "n4_4d",
            `In the new reading, what is the <b>value</b> of the digit that was highlighted in the original reading? <span class="endmark">[1]</span>`,
            1,
            digitAfter
          )
        ], ctx);
      }

      // 5 marks: scenario‑based (whole numbers only for digit-value-after-scaling steps)
      const lead = pickContextLead();
      const minStart = isCalc ? 30000 : 3000;
      const baseMaxStart = isCalc ? 999999 : 299999;

      const allowed5 = [10, 100, 1000, 10000];
      const limit5 = isCalc ? 9999999999 : 99999999;

      let mulF = 10, divF = 100, extraF = 1000, maxStart = baseMaxStart;
      for(let t=0; t<120; t++){
        mulF = rng.choice(allowed5);
        divF = rng.choice(allowed5.filter(x=>x!==mulF));
        extraF = rng.choice(allowed5.filter(x=>x!==mulF && x!==divF));

        // Avoid a net division that would create decimals in the displayed readings.
        if(mulF * extraF < divF) continue;

        const finalFactor = (mulF * extraF) / divF;
        const peakFactor = Math.max(mulF, finalFactor);
        const cap = Math.floor(limit5 / peakFactor);
        maxStart = Math.min(baseMaxStart, cap);
        if(maxStart >= minStart) break;
      }

      let startInt = makeWholeInt(minStart, maxStart);

      // Ensure the division step keeps the reading as a whole number.
      if(mulF < divF){
        const need = divF / mulF; // 10 or 100
        startInt = startInt - (startInt % need);
        if(startInt < minStart) startInt += need;
        if(startInt > maxStart) startInt -= need;
      }

      const start = makeHighlighted(String(startInt));
      const afterMul = startInt * mulF;
      const afterDiv = afterMul / divF;
      const final = afterDiv * extraF;
      const digitFinal = roundTo(start.value * (mulF / divF) * extraF, 12);

      const ctx =
        `${lead}<br>`+
        `A display shows the reading <b>${start.s}</b>.<br>`+
        `The reading is scaled in three steps: multiply by <b>${mulF}</b>, then divide by <b>${divF}</b>, then multiply by <b>${extraF}</b>.`;

      return Q([
        partNumber(
          "n4_5a",
          `In the reading <b>${start.html}</b>, what is the <b>value</b> of the highlighted digit? <span class="endmark">[1]</span>`,
          1,
          start.value
        ),
        partNumber(
          "n4_5b",
          `Work out the reading after multiplying by <b>${mulF}</b>. <span class="endmark">[1]</span>`,
          1,
          afterMul
        ),
        partNumber(
          "n4_5c",
          `The new reading is then divided by <b>${divF}</b>.<br>What is the reading now? <span class="endmark">[1]</span>`,
          1,
          afterDiv
        ),
        partNumber(
          "n4_5d",
          `The reading is then multiplied by <b>${extraF}</b>.<br>What is the final reading? <span class="endmark">[1]</span>`,
          1,
          final
        ),
        partNumber(
          "n4_5e",
          `In the final reading, what is the <b>value</b> of the digit that was highlighted in the original reading? <span class="endmark">[1]</span>`,
          1,
          digitFinal
        )
      ], ctx);
    }

    /* ===================== N5 Addition (integers & decimals) ===================== */
    case "N5": {
      const signedInt = (minAbs, maxAbs)=>{
        let v = rng.int(minAbs, maxAbs);
        if(rng.float() < 0.45) v = -v;
        return v;
      };

      const pickDigitsInt = (digits)=>{
        const ranges = {2:[10,99], 3:[100,999], 4:[1000,9999]};
        const [lo,hi] = ranges[digits] || [10,99];
        let v = rng.int(lo,hi);
        if(rng.float() < 0.35) v = -v;
        return v;
      };

      const pickDec = ()=>{
        // Decimal with integer part in tens/hundreds and up to 2 d.p. (no unnecessary trailing zeros displayed)
        const intMax = isCalc ? 999 : 199; // keep non-calc reasonable
        const intPart = rng.int(10, intMax);
        const frac = rng.int(1, 99);
        let v = intPart + frac/100;
        if(rng.float() < 0.25) v = -v;
        return v;
      };

      const pickMoney = (min, max)=>{
        if(!isCalc) return rng.int(min, max);
        return rng.int(Math.round(min*100), Math.round(max*100)) / 100;
      };
      const pickDec2 = (min, max)=>{
        return rng.int(Math.round(min*100), Math.round(max*100)) / 100;
      };
      const pickStepInt = (min, max, step)=>{
        const a = Math.ceil(min/step)*step;
        const b = Math.floor(max/step)*step;
        const n = Math.floor((b-a)/step);
        return a + rng.int(0, n) * step;
      };

      // 1–3 mark logic: non‑calculator uses whole numbers; calculator uses decimals.
      // Also ensure sign patterns differ between sub‑questions where required.
      const signPatterns = [[1,1],[1,-1],[-1,1],[-1,-1]];
      const pickPatterns = (k)=> rng.shuffle(signPatterns).slice(0, k);

      const pickIntBySign = (absMin, absMax, sign)=>{
        const v = rng.int(absMin, absMax);
        return sign < 0 ? -v : v;
      };

      const pickDecBySign = (intMin, intMax, dp, sign)=>{
        const intPart = rng.int(intMin, intMax);
        const fracMax = (10 ** dp) - 1;
        const frac = rng.int(1, fracMax); // ensure there is a decimal part
        const v = roundTo(intPart + frac / (10 ** dp), dp);
        return sign < 0 ? -v : v;
      };

      const addExprStr = (a, b, dp=6)=>{
        const aS = fmt(a, dp);
        const bS = fmt(b, dp);
        return `${aS} + ${b < 0 ? `(${bS})` : bS}`;
      };

      if(marksTotal === 1){
        if(!isCalc){
          const pat = rng.choice(signPatterns);
          const a = pickIntBySign(3, 60, pat[0]);
          const b = pickIntBySign(3, 60, pat[1]);
          return Q([
            partInteger(
              "n5_1",
              `Work out <b>${addExprStr(a,b)}</b>. <span class="endmark">[1]</span>`,
              1,
              a + b
            )
          ]);
        }

        // Calculator: decimals to 2 d.p., value in the tens/hundreds.
        const pat = rng.choice(signPatterns);
        const a = pickDecBySign(10, 999, 2, pat[0]);
        const b = pickDecBySign(10, 999, 2, pat[1]);
        return Q([
          partNumber(
            "n5_1",
            `Work out <b>${addExprStr(a,b,2)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(a + b, 12)
          )
        ]);
      }

      if(marksTotal === 2){
        const pats = pickPatterns(2);
        if(!isCalc){
          // Non‑calculator: whole numbers up to the hundreds.
          const a1 = pickIntBySign(10, 999, pats[0][0]);
          const a2 = pickIntBySign(10, 999, pats[0][1]);
          const b1 = pickIntBySign(10, 999, pats[1][0]);
          const b2 = pickIntBySign(10, 999, pats[1][1]);

          return Q([
            partInteger(
              "n5_2a",
              `Work out <b>${addExprStr(a1,a2)}</b>. <span class="endmark">[1]</span>`,
              1,
              a1 + a2
            ),
            partInteger(
              "n5_2b",
              `Work out <b>${addExprStr(b1,b2)}</b>. <span class="endmark">[1]</span>`,
              1,
              b1 + b2
            )
          ]);
        }

        // Calculator: decimals to 2 d.p. (different sign patterns in (a) and (b)).
        const a1 = pickDecBySign(10, 999, 2, pats[0][0]);
        const a2 = pickDecBySign(10, 999, 2, pats[0][1]);
        const b1 = pickDecBySign(10, 999, 2, pats[1][0]);
        const b2 = pickDecBySign(10, 999, 2, pats[1][1]);

        return Q([
          partNumber(
            "n5_2a",
            `Work out <b>${addExprStr(a1,a2,2)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(a1 + a2, 12)
          ),
          partNumber(
            "n5_2b",
            `Work out <b>${addExprStr(b1,b2,2)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(b1 + b2, 12)
          )
        ]);
      }

      if(marksTotal === 3){
        const pats = pickPatterns(3);
        if(!isCalc){
          // Non‑calculator: whole numbers up to the thousands place.
          const a1 = pickIntBySign(100, 999, pats[0][0]);
          const a2 = pickIntBySign(10, 99,  pats[0][1]);
          const b1 = pickIntBySign(1000, 9999, pats[1][0]);
          const b2 = pickIntBySign(100, 999,  pats[1][1]);
          const c1 = pickIntBySign(200, 9999, pats[2][0]);
          const c2 = pickIntBySign(200, 9999, pats[2][1]);

          return Q([
            partInteger(
              "n5_3a",
              `Work out <b>${addExprStr(a1,a2)}</b>. <span class="endmark">[1]</span>`,
              1,
              a1 + a2
            ),
            partInteger(
              "n5_3b",
              `Work out <b>${addExprStr(b1,b2)}</b>. <span class="endmark">[1]</span>`,
              1,
              b1 + b2
            ),
            partInteger(
              "n5_3c",
              `Work out <b>${addExprStr(c1,c2)}</b>. <span class="endmark">[1]</span>`,
              1,
              c1 + c2
            )
          ]);
        }

        // Calculator: decimals down to the one‑thousandth place; values up to the thousands.
        const a1 = pickDecBySign(10, 999, 3, pats[0][0]);
        const a2 = pickDecBySign(10, 999, 3, pats[0][1]);
        const b1 = pickDecBySign(100, 4999, 3, pats[1][0]);
        const b2 = pickDecBySign(100, 4999, 3, pats[1][1]);
        const c1 = pickDecBySign(500, 9999, 3, pats[2][0]);
        const c2 = pickDecBySign(500, 9999, 3, pats[2][1]);

        return Q([
          partNumber(
            "n5_3a",
            `Work out <b>${addExprStr(a1,a2,3)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(a1 + a2, 12)
          ),
          partNumber(
            "n5_3b",
            `Work out <b>${addExprStr(b1,b2,3)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(b1 + b2, 12)
          ),
          partNumber(
            "n5_3c",
            `Work out <b>${addExprStr(c1,c2,3)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(c1 + c2, 12)
          )
        ]);
      }

      
      if(marksTotal === 4){
        // Tables + wording follow the supplied "N5 & N6 Qs" pattern.
        const scenario = rng.int(1, 3);

        if(scenario === 1){
          // Theme Park Souvenir Stall (Money) — total 4 marks
          const bracelet = pickMoney(isCalc ? 4 : 3, isCalc ? 12 : 9);
          const glow     = pickMoney(isCalc ? 0.8 : 1, isCalc ? 4 : 4);
          const badge    = pickMoney(isCalc ? 1 : 2, isCalc ? 5 : 6);
          const bead     = pickMoney(isCalc ? 0.2 : 1, isCalc ? 2.5 : 2);

          const qRubyBracelets = rng.int(2, 5);
          let qRubyGlows       = rng.int(2, 5);
          if(qRubyGlows === qRubyBracelets) qRubyGlows = (qRubyGlows === 5) ? 4 : (qRubyGlows + 1);

          const tableHtml = `
            <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:360px">
              <thead>
                <tr>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item</th>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">Price</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Bracelet</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(bracelet,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Glow ring</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(glow,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Badge</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(badge,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Name bead</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(bead,2)} each</b></td>
                </tr>
              </tbody>
            </table>
          `

          const totalRuby = roundTo(qRubyBracelets*bracelet + qRubyGlows*glow, 12);
          const totalSam  = roundTo(badge + bead, 12);

          const ctx =
            `A theme park sells souvenirs.<br>`+
            `The price list is shown below.<br>`+
            `${tableHtml}`;

          return Q([
            partNumber(
              "n5_4a",
              `Sam buys 1 badge and 1 name bead.<br>Work out the total cost. <span class="endmark">[1]</span>`,
              1,
              totalSam
            ),
            partNumber(
              "n5_4b",
              `Ruby buys ${qRubyBracelets} bracelets and ${qRubyGlows} glow rings.<br>Work out the total cost. <span class="endmark">[3]</span>`,
              3,
              totalRuby
            )
          ], ctx);
        }

        if(scenario === 2){
          // Camping Supplies (Mass) — total 4 marks
          // Non‑calc in grams; calc in kilograms. Values regenerate each time.
          const waterG = pickStepInt(300, 900, 10);
          const snackG = pickStepInt(80, 220, 10);
          const torchG = pickStepInt(120, 360, 10);
          const mapG   = pickStepInt(50, 160, 10);

          const water = isCalc ? roundTo(waterG/1000, 2) : waterG;
          const snack = isCalc ? roundTo(snackG/1000, 2) : snackG;
          const torch = isCalc ? roundTo(torchG/1000, 2) : torchG;
          const map   = isCalc ? roundTo(mapG/1000, 2) : mapG;

          const unit = isCalc ? "kg" : "g";

          const qWater = rng.int(2, 5);
          let qTorch   = rng.int(2, 5);
          if(qTorch === qWater) qTorch = (qTorch === 5) ? 4 : (qTorch + 1);

          const tableHtml = `
            <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:360px">
              <thead>
                <tr>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item</th>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">Mass (${unit})</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Water bottle</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(water,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Snack bar</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(snack,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Torch</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(torch,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Map</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(map,2)}</b></td>
                </tr>
              </tbody>
            </table>
          `

          const totalMass = roundTo(qWater*water + qTorch*torch, 12);
          const extraMass = roundTo(snack + map, 12);

          const ctx =
            `The masses are shown below.<br>`+
            `${tableHtml}`;

          return Q([
            partNumber(
              "n5_4a",
              `The camper adds 1 snack bar and 1 map.<br>Work out the extra mass added. <span class="endmark">[1]</span>`,
              1,
              extraMass
            ),
            partNumber(
              "n5_4b",
              `A camper packs ${qWater} water bottles and ${qTorch} torches.<br>Work out the total mass. <span class="endmark">[3]</span>`,
              3,
              totalMass
            )
          ], ctx);
        }

        // Household Electricity Use (Power) — total 4 marks
        const kettle    = isCalc ? pickDec2(1200, 3000) : pickStepInt(1200, 3000, 50);
        const microwave = isCalc ? pickDec2(500, 1600)  : pickStepInt(500, 1600, 50);
        const tv        = isCalc ? pickDec2(60, 220)    : pickStepInt(60, 220, 10);
        const lamp      = isCalc ? pickDec2(20, 120)    : pickStepInt(20, 120, 10);

        const qKettle    = rng.int(2, 5);
        let qMicrowave   = rng.int(2, 5);
        if(qMicrowave === qKettle) qMicrowave = (qMicrowave === 5) ? 4 : (qMicrowave + 1);

        const tableHtml = `
          <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:420px">
            <thead>
              <tr>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Appliance</th>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">Power (W)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Kettle</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(kettle,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Microwave</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(microwave,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">TV</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(tv,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Lamp</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(lamp,2)}</b></td>
              </tr>
            </tbody>
          </table>
        `

        const totalUse = roundTo(qKettle*kettle + qMicrowave*microwave, 12);
        const totalOn  = roundTo(tv + lamp, 12);

        const ctx =
          `The power used by appliances is shown below.<br>`+
          `${tableHtml}`;

        return Q([
          partNumber(
            "n5_4a",
            `They also switch on 1 TV and 1 lamp.<br>Work out the total power (in W). <span class="endmark">[1]</span>`,
            1,
            totalOn
          ),
          partNumber(
            "n5_4b",
            `In one day, a family uses ${qKettle} kettle boils and ${qMicrowave} microwave uses.<br>Work out the total power used (in W) for these uses. <span class="endmark">[3]</span>`,
            3,
            totalUse
          )
        ], ctx);
      }

      // 5 marks: tables + wording follow the supplied "N5 & N6 Qs" pattern.
      const scenario5 = rng.int(1, 3);

      if(scenario5 === 1){
        // Supermarket Self-Checkout (Money) — total 5 marks
        const sandwich = pickMoney(isCalc ? 5 : 2, isCalc ? 30 : 7);
        const yogurt   = pickMoney(isCalc ? 4 : 1, isCalc ? 28 : 6);
        const water    = pickMoney(isCalc ? 1 : 1, isCalc ? 15 : 4);
        const fruit    = pickMoney(isCalc ? 2 : 1, isCalc ? 20 : 4);

        const qZaraSand = rng.int(2, 5);
        let qZaraYog    = rng.int(2, 5);
        if(qZaraYog === qZaraSand) qZaraYog = (qZaraYog === 5) ? 4 : (qZaraYog + 1);
        const qAmirFruit = rng.int(2, 5);

        const tableHtml = `
          <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:380px">
            <thead>
              <tr>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item</th>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">Price</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Sandwich</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(sandwich,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Yogurt pot</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(yogurt,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Bottle of water</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(water,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Fruit snack</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(fruit,2)} each</b></td>
              </tr>
            </tbody>
          </table>
        `

        const totalZara = roundTo(qZaraSand*sandwich + qZaraYog*yogurt, 12);
        const totalAmir = roundTo(sandwich + qAmirFruit*fruit, 12);

        const ctx =
          `A supermarket sells the items below.<br>`+
          `${tableHtml}`;

        return Q([
          partNumber(
            "n5_5a",
            `Amir buys 1 sandwich and ${qAmirFruit} fruit snacks.<br>Work out the total cost. <span class="endmark">[2]</span>`,
            2,
            totalAmir
          ),
          partNumber(
            "n5_5b",
            `Zara buys ${qZaraSand} sandwiches and ${qZaraYog} yogurt pots.<br>Work out the total cost. <span class="endmark">[3]</span>`,
            3,
            totalZara
          )
        ], ctx);
      }

      if(scenario5 === 2){
        // Bus Journey Times (Time) — total 5 marks
        const a = isCalc ? pickDec2(80, 160) : rng.int(10, 30);
        const b = isCalc ? pickDec2(70, 150) : rng.int(8, 25);
        const c = isCalc ? pickDec2(80, 160) : rng.int(10, 30);
        const d = isCalc ? pickDec2(80, 170) : rng.int(10, 35);

        const qTownStation = rng.int(2, 5);
        let qStationRetail = rng.int(2, 5);
        if(qStationRetail === qTownStation) qStationRetail = (qStationRetail === 5) ? 4 : (qStationRetail + 1);
        const qCollege = rng.int(2, 5);

        const tableHtml = `
          <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:420px">
            <thead>
              <tr>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Journey</th>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">Time (minutes)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Town Centre → Station</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(a,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Station → Retail Park</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(b,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Retail Park → Sports Centre</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(c,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Sports Centre → College</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(d,2)}</b></td>
              </tr>
            </tbody>
          </table>
        `

        const totalHard = roundTo(qTownStation*a + qStationRetail*b, 12);
        const totalEasy = roundTo(c + qCollege*d, 12);

        const ctx =
          `A bus company records journey times between stops.<br>`+
          `${tableHtml}`;

        return Q([
          partNumber(
            "n5_5a",
            `Another passenger makes 1 journey Retail Park → Sports Centre and ${qCollege} journeys Sports Centre → College.<br>Work out the total time. <span class="endmark">[2]</span>`,
            2,
            totalEasy
          ),
          partNumber(
            "n5_5b",
            `A passenger makes ${qTownStation} journeys Town Centre → Station and ${qStationRetail} journeys Station → Retail Park.<br>Work out the total time. <span class="endmark">[3]</span>`,
            3,
            totalHard
          )
        ], ctx);
      }

      // School Print Room (Pages / Cost) — total 5 marks
      const a = isCalc ? pickDec2(30, 180) : rng.int(60, 180); // Homework packs
      const b = isCalc ? pickDec2(30, 160) : rng.int(50, 160); // Revision sheets
      const c = isCalc ? pickDec2(10, 120) : rng.int(20, 120); // Permission slips
      const d = isCalc ? pickDec2(10, 160) : rng.int(30, 160); // Club posters

      const qHomework = rng.int(2, 5);
      let qRevision   = rng.int(2, 5);
      if(qRevision === qHomework) qRevision = (qRevision === 5) ? 4 : (qRevision + 1);
      const qPerm = rng.int(2, 5);

      const isCost = isCalc;
      const colTitle = isCost ? "Cost per job (£)" : "Pages per job";

      const tableHtml = `
        <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:420px">
          <thead>
            <tr>
              <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
              <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Print job</th>
              <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">${colTitle}</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">Homework packs</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(a,2)}</b></td>
            </tr>
            <tr>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">Revision sheets</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(b,2)}</b></td>
            </tr>
            <tr>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">Permission slips</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(c,2)}</b></td>
            </tr>
            <tr>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">Club posters</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(d,2)}</b></td>
            </tr>
          </tbody>
        </table>
      `

      const totalHard = roundTo(qHomework*a + qRevision*b, 12);
      const totalEasy = roundTo(d + qPerm*c, 12);

      const ctx =
        `A school print room counts pages printed for different jobs.<br>`+
        `The table shows ${isCost ? "cost per job (£)" : "pages per job"}.<br>`+
        `${tableHtml}`;

      return Q([
        partNumber(
          "n5_5a",
          `Later, the print room completes 1 club poster job and ${qPerm} permission slip jobs.<br>Work out the total ${isCost ? "cost" : "number of pages printed"}. <span class="endmark">[2]</span>`,
          2,
          totalEasy
        ),
        partNumber(
          "n5_5b",
          `The print room completes ${qHomework} homework pack jobs and ${qRevision} revision sheet jobs.<br>Work out the total ${isCost ? "cost" : "number of pages printed"}. <span class="endmark">[3]</span>`,
          3,
          totalHard
        )
      ], ctx);
    }


case "N6": {
      const signedInt = (minAbs, maxAbs)=>{
        let v = rng.int(minAbs, maxAbs);
        if(rng.float() < 0.45) v = -v;
        return v;
      };

      const pickDigitsInt = (digits)=>{
        const ranges = {2:[10,99], 3:[100,999], 4:[1000,9999]};
        const [lo,hi] = ranges[digits] || [10,99];
        let v = rng.int(lo,hi);
        if(rng.float() < 0.35) v = -v;
        return v;
      };

      const pickDec = ()=>{
        const intMax = isCalc ? 999 : 199;
        const intPart = rng.int(10, intMax);
        const frac = rng.int(1, 99);
        let v = intPart + frac/100;
        if(rng.float() < 0.25) v = -v;
        return v;
      };

      const pickMoney = (min, max)=>{
        if(!isCalc) return rng.int(min, max);
        return rng.int(Math.round(min*100), Math.round(max*100)) / 100;
      };
      const pickDec2 = (min, max)=>{
        return rng.int(Math.round(min*100), Math.round(max*100)) / 100;
      };
      const pickStepInt = (min, max, step)=>{
        const a = Math.ceil(min/step)*step;
        const b = Math.floor(max/step)*step;
        const n = Math.floor((b-a)/step);
        return a + rng.int(0, n) * step;
      };

      // 1–3 mark logic: non‑calculator uses whole numbers; calculator uses decimals.
      // Also ensure sign patterns differ between sub‑questions where required.
      const signPatterns = [[1,1],[1,-1],[-1,1],[-1,-1]];
      const pickPatterns = (k)=> rng.shuffle(signPatterns).slice(0, k);

      const pickIntBySign = (absMin, absMax, sign)=>{
        const v = rng.int(absMin, absMax);
        return sign < 0 ? -v : v;
      };

      const pickDecBySign = (intMin, intMax, dp, sign)=>{
        const intPart = rng.int(intMin, intMax);
        const fracMax = (10 ** dp) - 1;
        const frac = rng.int(1, fracMax); // ensure there is a decimal part
        const v = roundTo(intPart + frac / (10 ** dp), dp);
        return sign < 0 ? -v : v;
      };

      const subExprStr = (a, b, dp=6)=>{
        const aS = fmt(a, dp);
        const bS = fmt(b, dp);
        return `${aS} − ${b < 0 ? `(${bS})` : bS}`;
      };

      if(marksTotal === 1){
        if(!isCalc){
          const pat = rng.choice(signPatterns);
          const a = pickIntBySign(5, 80, pat[0]);
          const b = pickIntBySign(5, 80, pat[1]);
          return Q([
            partInteger(
              "n6_1",
              `Work out <b>${subExprStr(a,b)}</b>. <span class="endmark">[1]</span>`,
              1,
              a - b
            )
          ]);
        }

        // Calculator: decimals to 2 d.p., with values mainly in the tens.
        const pat = rng.choice(signPatterns);
        const a = pickDecBySign(10, 99, 2, pat[0]);
        const b = pickDecBySign(10, 99, 2, pat[1]);
        return Q([
          partNumber(
            "n6_1",
            `Work out <b>${subExprStr(a,b,2)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(a - b, 12)
          )
        ]);
      }

      if(marksTotal === 2){
        const pats = pickPatterns(2);
        if(!isCalc){
          // Non‑calculator: whole numbers (up to the thousands place).
          const a1 = pickIntBySign(10, 999,  pats[0][0]);
          const a2 = pickIntBySign(10, 999,  pats[0][1]);
          const b1 = pickIntBySign(100, 9999, pats[1][0]);
          const b2 = pickIntBySign(100, 9999, pats[1][1]);

          return Q([
            partInteger(
              "n6_2a",
              `Work out <b>${subExprStr(a1,a2)}</b>. <span class="endmark">[1]</span>`,
              1,
              a1 - a2
            ),
            partInteger(
              "n6_2b",
              `Work out <b>${subExprStr(b1,b2)}</b>. <span class="endmark">[1]</span>`,
              1,
              b1 - b2
            )
          ]);
        }

        // Calculator: decimals to 2 d.p. (different sign patterns in (a) and (b)).
        const a1 = pickDecBySign(10, 999, 2, pats[0][0]);
        const a2 = pickDecBySign(10, 999, 2, pats[0][1]);
        const b1 = pickDecBySign(10, 999, 2, pats[1][0]);
        const b2 = pickDecBySign(10, 999, 2, pats[1][1]);

        return Q([
          partNumber(
            "n6_2a",
            `Work out <b>${subExprStr(a1,a2,2)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(a1 - a2, 12)
          ),
          partNumber(
            "n6_2b",
            `Work out <b>${subExprStr(b1,b2,2)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(b1 - b2, 12)
          )
        ]);
      }

      if(marksTotal === 3){
        const pats = pickPatterns(3);
        if(!isCalc){
          // Non‑calculator: whole numbers up to the thousands place.
          const a1 = pickIntBySign(100, 999,   pats[0][0]);
          const a2 = pickIntBySign(10,  99,    pats[0][1]);
          const b1 = pickIntBySign(1000, 9999, pats[1][0]);
          const b2 = pickIntBySign(100,  999,  pats[1][1]);
          const c1 = pickIntBySign(200,  9999, pats[2][0]);
          const c2 = pickIntBySign(200,  9999, pats[2][1]);

          return Q([
            partInteger(
              "n6_3a",
              `Work out <b>${subExprStr(a1,a2)}</b>. <span class="endmark">[1]</span>`,
              1,
              a1 - a2
            ),
            partInteger(
              "n6_3b",
              `Work out <b>${subExprStr(b1,b2)}</b>. <span class="endmark">[1]</span>`,
              1,
              b1 - b2
            ),
            partInteger(
              "n6_3c",
              `Work out <b>${subExprStr(c1,c2)}</b>. <span class="endmark">[1]</span>`,
              1,
              c1 - c2
            )
          ]);
        }

        // Calculator: decimals to 2 d.p.; values up to the thousands.
        const a1 = pickDecBySign(10, 999, 2, pats[0][0]);
        const a2 = pickDecBySign(10, 999, 2, pats[0][1]);
        const b1 = pickDecBySign(100, 4999, 2, pats[1][0]);
        const b2 = pickDecBySign(100, 4999, 2, pats[1][1]);
        const c1 = pickDecBySign(500, 9999, 2, pats[2][0]);
        const c2 = pickDecBySign(500, 9999, 2, pats[2][1]);

        return Q([
          partNumber(
            "n6_3a",
            `Work out <b>${subExprStr(a1,a2,2)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(a1 - a2, 12)
          ),
          partNumber(
            "n6_3b",
            `Work out <b>${subExprStr(b1,b2,2)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(b1 - b2, 12)
          ),
          partNumber(
            "n6_3c",
            `Work out <b>${subExprStr(c1,c2,2)}</b>. <span class="endmark">[1]</span>`,
            1,
            roundTo(c1 - c2, 12)
          )
        ]);
      }

      
      if(marksTotal === 4){
        // Tables + wording follow the supplied "N5 & N6 Qs" pattern.
        const scenario = rng.int(1, 3);

        if(scenario === 1){
          // Supermarket Receipt Check (Money) — total 4 marks
          const start = 30;

          const qChicken = rng.int(2, 3);
          const qCheese  = (qChicken === 2) ? 3 : 2;

          let bread, cheese, chicken, apples;
          // Choose values that keep the purchases within the start amount.
          for(let tries=0; tries<200; tries++){
            if(isCalc){
              bread = pickMoney(1.5, 6.5);
              cheese = pickMoney(2.5, 7.5);
              chicken = pickMoney(3.5, 9.5);
              apples = pickMoney(2, 7);
            } else {
              bread = pickMoney(2, 6);
              cheese = pickMoney(3, 8);
              chicken = pickMoney(4, 10);
              apples = pickMoney(2, 7);
            }
            if(qChicken*chicken + qCheese*cheese <= start - 0.5) break;
          }

          const tableHtml = `
            <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:380px">
              <thead>
                <tr>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item</th>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">Price</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Bread</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(bread,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Cheese</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(cheese,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Chicken pieces</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(chicken,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Apples (bag)</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(apples,2)}</b></td>
                </tr>
              </tbody>
            </table>
          `

          const leftMain = roundTo(start - (qChicken*chicken + qCheese*cheese), 12);
          const leftNote = roundTo(10 - bread, 12);

          const ctx =
            `A customer has £${fmt(start,2)} to spend. The prices are shown below.<br>`+
            `${tableHtml}`;

          return Q([
            partNumber(
              "n6_4a",
              `The customer buys bread.<br>How much change is left from a £10 note? <span class="endmark">[1]</span>`,
              1,
              leftNote
            ),
            partNumber(
              "n6_4b",
              `The customer buys ${qChicken} chicken pieces and ${qCheese} cheeses.<br>How much money is left from £${fmt(start,2)}? <span class="endmark">[3]</span>`,
              3,
              leftMain
            )
          ], ctx);
        }

        if(scenario === 2){
          // Mobile Data Allowance (Data) — total 4 marks
          const start = 50;

          const qVideo  = rng.int(2, 3);
          const qSocial = (qVideo === 2) ? 3 : 2;

          let video, social, music, maps, day;
          for(let tries=0; tries<200; tries++){
            if(isCalc){
              video = pickDec2(8, 12);
              social = pickDec2(3, 6);
              music = pickDec2(2, 8);
              maps = pickDec2(1, 5);
              day = pickDec2(2, 10);
            } else {
              video = rng.int(10, 25);
              social = rng.int(5, 15);
              music = rng.int(4, 10);
              maps = rng.int(2, 8);
              day = rng.int(4, 20);
            }
            if(qVideo*video + qSocial*social <= start - 1) break;
          }

          const tableHtml = `
            <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:460px">
              <thead>
                <tr>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Use</th>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">Data used (GB)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Video streaming (week)</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(video,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Social media (week)</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(social,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Music (week)</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(music,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Maps (week)</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(maps,2)}</b></td>
                </tr>
              </tbody>
            </table>
          `

          const leftMain = roundTo(start - (qVideo*video + qSocial*social), 12);
          const leftDay  = roundTo(start - day, 12);

          const ctx =
            `A phone plan includes ${fmt(start,2)} GB of data per month.<br>`+
            `${tableHtml}`;

          return Q([
            partNumber(
              "n6_4a",
              `In one day, Arjun uses ${fmt(day,2)} GB.<br>How much is left from ${fmt(start,2)} GB? <span class="endmark">[1]</span>`,
              1,
              leftDay
            ),
            partNumber(
              "n6_4b",
              `In one week, Arjun uses ${qVideo} video streaming sessions and ${qSocial} social media sessions.<br>How much data is left from ${fmt(start,2)} GB? <span class="endmark">[3]</span>`,
              3,
              leftMain
            )
          ], ctx);
        }

        // Fuel in a Car (Litres) — total 4 marks
        const start = 60;

        const qSchool = rng.int(2, 3);
        const qShop   = (qSchool === 2) ? 3 : 2;

        let school, shop, training, family, after;
        for(let tries=0; tries<200; tries++){
          if(isCalc){
            school = pickDec2(4, 9);
            shop = pickDec2(6, 14);
            training = pickDec2(5, 12);
            family = pickDec2(8, 18);
            after = pickDec2(15, 45);
          } else {
            school = rng.int(4, 9);
            shop = rng.int(6, 14);
            training = rng.int(5, 12);
            family = rng.int(8, 18);
            after = rng.int(15, 45);
          }
          if(qSchool*school + qShop*shop <= start - 1) break;
        }

        const tableHtml = `
            <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:420px">
              <thead>
                <tr>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Trip</th>
                  <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">Fuel used (litres)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">School run</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(school,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Shopping trip</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(shop,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Football training</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(training,2)}</b></td>
                </tr>
                <tr>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;">Visiting family</td>
                  <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(family,2)}</b></td>
                </tr>
              </tbody>
            </table>
          `

        const leftMain = roundTo(start - (qSchool*school + qShop*shop), 12);
        const usedFromFull = roundTo(start - after, 12);

        const ctx =
          `A car has ${fmt(start,2)} litres in the tank at the start of the week.<br>`+
          `${tableHtml}`;

        return Q([
          partNumber(
            "n6_4a",
            `After a trip, the tank has ${fmt(after,2)} litres left.<br>How many litres were used from a full ${fmt(start,2)}-litre tank? <span class="endmark">[1]</span>`,
            1,
            usedFromFull
          ),
          partNumber(
            "n6_4b",
            `The driver does ${qSchool} school runs and ${qShop} shopping trips.<br>How many litres are left from ${fmt(start,2)} litres? <span class="endmark">[3]</span>`,
            3,
            leftMain
          )
        ], ctx);
      }

      const scenario5 = rng.int(1, 3);

      if(scenario5 === 1){
        // Cinema Budget (Money) — total 5 marks
        const start = 80;

        const qDrinks  = rng.int(2, 5);
        const qPopcorn = rng.int(2, 5);
        let qSweets    = rng.int(2, 5);
        if(qSweets === qPopcorn) qSweets = (qSweets === 5) ? 4 : (qSweets + 1);

        let ticket, popcorn, drink, sweets;
        for(let tries=0; tries<500; tries++){
          if(isCalc){
            ticket = pickMoney(6, 12);
            drink  = pickMoney(2, 6);
            popcorn = pickMoney(1, 8);
            sweets = pickMoney(1, 5);
          } else {
            ticket = rng.int(6, 12);
            drink  = rng.int(2, 6);
            popcorn = rng.int(1, 8);
            sweets = rng.int(1, 5);
          }
          const afterA = start - (ticket + qDrinks*drink);
          const afterB = afterA - (qPopcorn*popcorn + qSweets*sweets);
          if(afterB >= 0) break;
        }

        const tableHtml = `
          <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:380px">
            <thead>
              <tr>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item</th>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">Price</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Ticket</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(ticket,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Popcorn</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(popcorn,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Drink</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(drink,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Sweets</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>£${fmt(sweets,2)}</b></td>
              </tr>
            </tbody>
          </table>
        `

        const afterA = roundTo(start - (ticket + qDrinks*drink), 12);
        const afterB = roundTo(afterA - (qPopcorn*popcorn + qSweets*sweets), 12);

        const ctx =
          `A group has £${fmt(start,2)} to spend. Prices are shown below.<br>`+
          `${tableHtml}`;

        return Q([
          partNumber(
            "n6_5a",
            `They buy 1 ticket and ${qDrinks} drinks.<br>How much money is left from £${fmt(start,2)}? <span class="endmark">[2]</span>`,
            2,
            afterA
          ),
          partNumber(
            "n6_5b",
            `They then buy ${qPopcorn} popcorns and ${qSweets} sweets.<br>How much money is left now? <span class="endmark">[3]</span>`,
            3,
            afterB
          )
        ], ctx);
      }

      if(scenario5 === 2){
        // Train Journey Time Remaining (Time) — total 5 marks
        const planned = 140;

        const qSlow    = rng.int(2, 5);
        const qStop    = rng.int(2, 5);
        let qBoard     = rng.int(2, 5);
        if(qBoard === qStop) qBoard = (qBoard === 5) ? 4 : (qBoard + 1);

        let signals, slow, stop, boarding;
        for(let tries=0; tries<300; tries++){
          if(isCalc){
            signals = pickDec2(10, 30);
            slow = pickDec2(15, 40);
            stop = pickDec2(5, 20);
            boarding = pickDec2(4, 15);
          } else {
            signals = rng.int(10, 30);
            slow = rng.int(15, 40);
            stop = rng.int(5, 20);
            boarding = rng.int(4, 15);
          }
          const afterA = planned - (signals + qSlow*slow);
          const afterB = afterA - (qStop*stop + qBoard*boarding);
          if(afterB >= 0) break;
        }

        const tableHtml = `
          <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:460px">
            <thead>
              <tr>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Delay / time used</th>
                <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">Minutes</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Waiting at signals</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(signals,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Slow section of track</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(slow,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Extra stop</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(stop,2)}</b></td>
              </tr>
              <tr>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;">Boarding delay</td>
                <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(boarding,2)}</b></td>
              </tr>
            </tbody>
          </table>
        `

        const afterA = roundTo(planned - (signals + qSlow*slow), 12);
        const afterB = roundTo(afterA - (qStop*stop + qBoard*boarding), 12);

        const ctx =
          `A train journey is planned to take ${fmt(planned,2)} minutes.<br>`+
          `${tableHtml}`;

        return Q([
          partNumber(
            "n6_5a",
            `The train loses the time for waiting at signals and goes through ${qSlow} slow sections of track.<br>How many minutes are left from the planned ${fmt(planned,2)} minutes? <span class="endmark">[2]</span>`,
            2,
            afterA
          ),
          partNumber(
            "n6_5b",
            `Then there are ${qStop} extra stops and ${qBoard} boarding delays.<br>How many minutes are left now? <span class="endmark">[3]</span>`,
            3,
            afterB
          )
        ], ctx);
      }

      // Warehouse Stock Remaining (Items / Mass) — total 5 marks
      const start = 900;
      const isKg = isCalc;

      const qB = rng.int(2, 5);
      const qC = rng.int(2, 5);
      let qD   = rng.int(2, 5);
      if(qD === qC) qD = (qD === 5) ? 4 : (qD + 1);

      let A, B, C, D;
      for(let tries=0; tries<400; tries++){
        if(isKg){
          A = pickDec2(60, 220);
          B = pickDec2(60, 220);
          C = pickDec2(60, 220);
          D = pickDec2(60, 220);
        } else {
          A = rng.int(60, 220);
          B = rng.int(60, 220);
          C = rng.int(60, 220);
          D = rng.int(60, 220);
        }

        const afterA = start - (A + qB*B);
        const afterB = afterA - (qC*C + qD*D);
        if(afterB >= 0) break;
      }

      const colTitle = isKg ? "Mass shipped (kg)" : "Items shipped";

      const tableHtml = `
        <table style="border-collapse:collapse;margin:.55rem 0 .2rem 0;min-width:420px">
          <thead>
            <tr>
              <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Item number</th>
              <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:left;">Order shipped</th>
              <th style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;">${colTitle}</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">1</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">Order A</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(A,2)}</b></td>
            </tr>
            <tr>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">2</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">Order B</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(B,2)}</b></td>
            </tr>
            <tr>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">3</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">Order C</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(C,2)}</b></td>
            </tr>
            <tr>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">4</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;">Order D</td>
              <td style="border:1px solid var(--border);padding:.35rem .5rem;text-align:right;"><b>${fmt(D,2)}</b></td>
            </tr>
          </tbody>
        </table>
      `

      const afterA = roundTo(start - (A + qB*B), 12);
      const afterB = roundTo(afterA - (qC*C + qD*D), 12);

      const ctx =
        `A warehouse starts the day with ${fmt(start,2)} ${isKg ? "kg of stock" : "items in stock"}.<br>`+
        `${tableHtml}`;

      return Q([
        partNumber(
          "n6_5a",
          `The warehouse ships Order A and ${qB} lots of Order B.<br>How many ${isKg ? "kg" : "items"} are left from ${fmt(start,2)}? <span class="endmark">[2]</span>`,
          2,
          afterA
        ),
        partNumber(
          "n6_5b",
          `Then the warehouse ships ${qC} lots of Order C and ${qD} lots of Order D.<br>How many ${isKg ? "kg" : "items"} are left now? <span class="endmark">[3]</span>`,
          3,
          afterB
        )
      ], ctx);
    }/* SPLITMERGE:BUILDQUESTION-CASES-END */


default:
      return Q([partNumber("x", `Not implemented. <span class="endmark">[${marksTotal}]</span>`, marksTotal, 0)]);
  }
}

// SECTION: Rendering + inputs
// - Builds the per-question HTML (question text, answer inputs, mark buttons).
// - Installs widget behaviour for:
//   • standard form EXP entry (single input)
//   • drag-and-drop ordering tiles
//   • numeric/text answer validation
const topicSel = document.getElementById("topicSel");
const marksSel = document.getElementById("marksSel");
const calcSel  = document.getElementById("calcSel");
const preview  = document.getElementById("preview");
const fb       = document.getElementById("fb");

const regenBtn = document.getElementById("regenBtn");
const checkBtn = document.getElementById("checkBtn");
const revealBtn= document.getElementById("revealBtn");

let current = null;

function initTopicDropdown(){
  TOPICS.forEach(t=>{
    const o=document.createElement("option");
    o.value=t.code;
    o.textContent=`${t.code} — ${t.name}`;
    topicSel.appendChild(o);
  });
  topicSel.value = "N4"; // default: simplify fractions (a commonly tested topic)
}

function paperTagHtml(paperMode){
  return paperMode==="calc"
    ? `<span class="nc-tag calc">CALCULATOR</span>`
    : `<span class="nc-tag nc">NON‑CALCULATOR</span>`;
}

function renderInput(input, answerType, baseId){
  if (!input) return "";
  const kind = input.kind;

  if (kind==="fraction" || answerType==="fraction"){
    return `
      <span class="frac" aria-label="fraction answer">
        <input id="${baseId}N" class="mini" type="text" inputmode="numeric" placeholder="numerator" />
        <span class="bar"></span>
        <input id="${baseId}D" class="mini" type="text" inputmode="numeric" placeholder="denominator" />
      </span>
    `;
  }

  if (kind==="pair"){
    const lab0 = input.labels?.[0];
    const lab1 = input.labels?.[1];
    const ph0 = input.placeholders?.[0]||"a";
    const ph1 = input.placeholders?.[1]||"b";
    const labelHtml = (t)=> t ? `<span style="font-weight:900;color:#111827">${t}</span>` : "";
    return `
      <span class="twobox" aria-label="two answers">
        ${labelHtml(lab0)}
        <input id="${baseId}A" class="mini" type="text" inputmode="decimal" placeholder="${ph0}" />
        ${labelHtml(lab1)}
        <input id="${baseId}B" class="mini" type="text" inputmode="decimal" placeholder="${ph1}" />
      </span>
    `;
  }

  if (kind==="triple"){
    return `
      <span class="threebox" aria-label="three answers">
        <input id="${baseId}A" class="mini" type="text" inputmode="decimal" placeholder="${input.placeholders?.[0]||"a"}" />
        <input id="${baseId}B" class="mini" type="text" inputmode="decimal" placeholder="${input.placeholders?.[1]||"b"}" />
        <input id="${baseId}C" class="mini" type="text" inputmode="decimal" placeholder="${input.placeholders?.[2]||"c"}" />
      </span>
    `;
  }

  if (kind==="standardForm" || answerType==="standardForm"){
    // Single entry box only. Press EXP to insert ×10 and then type the power as a superscript.
    return `
      <div class="sfwrap" aria-label="standard form answer">
        <input id="${baseId}" class="sfinput" type="text" inputmode="decimal" placeholder="e.g. 3.2×10⁵" autocomplete="off" />
        <div class="keypad sfctrl" data-sf-target="${baseId}">
          <button class="kbtn accent" data-act="exp">EXP</button>
          <button class="kbtn" data-act="neg">±</button>
          <button class="kbtn" data-act="bksp">⌫</button>
          <button class="kbtn" data-act="clear">Clear</button>
        </div>
        <div class="sfhint">Type the number. Press <b>EXP</b> to insert <b>×10</b> with a superscript power.</div>
      </div>
    `;
  }


  if (kind==="primeFactors" || answerType==="primeFactors"){
    // Visual box + hidden canonical string (uses ^ internally, never shown)
    return `
      <div class="pfwrap" aria-label="prime factorisation answer">
        <div class="pfbox" id="${baseId}Box" tabindex="0" aria-label="prime factorisation input"></div>
        <input id="${baseId}" type="hidden" value="" />
        <div class="keypad" data-target="${baseId}" data-exp="0">
          <button class="kbtn" data-prime="2">2</button>
          <button class="kbtn" data-prime="3">3</button>
          <button class="kbtn" data-prime="5">5</button>
          <button class="kbtn" data-prime="7">7</button>
          <button class="kbtn" data-prime="11">11</button>
          <button class="kbtn primary" data-ins="×">×</button>

          <button class="kbtn" data-act="exp" aria-pressed="false">EXP</button>
          <button class="kbtn" data-digit="1">1</button>
          <button class="kbtn" data-digit="2">2</button>
          <button class="kbtn" data-digit="3">3</button>
          <button class="kbtn" data-digit="4">4</button>
          <button class="kbtn" data-digit="5">5</button>

          <button class="kbtn" data-digit="6">6</button>
          <button class="kbtn" data-digit="7">7</button>
          <button class="kbtn" data-digit="8">8</button>
          <button class="kbtn" data-digit="9">9</button>
          <button class="kbtn" data-digit="0">0</button>
          <button class="kbtn" data-act="bksp">⌫</button>

          <button class="kbtn danger" data-act="clear" style="grid-column:1 / span 6">Clear</button>
        </div>
      </div>
    `;
  }

  

  if (kind==="order" || answerType==="order"){
    // Drag-order widgets render inside the question text; nothing to render here.
    return ``;
  }
if (kind==="money"){
    return `<input id="${baseId}" type="text" inputmode="decimal" placeholder="£" style="min-width:140px" />`;
  }

  if (kind==="int" || kind==="integer"){

    return `<input id="${baseId}" type="text" inputmode="numeric" placeholder="answer" style="min-width:140px" />`;
  }

  return `<input id="${baseId}" type="text" inputmode="decimal" placeholder="answer" style="min-width:160px" />`;
}

function renderQuestion(q){
  const topicName = TOPICS.find(t=>t.code===q.topicCode)?.name ?? q.topicCode;
  const title = `${q.topicCode} — ${topicName}`;
  const badge = `<span class="badge">[${q.marksTotal} mark${q.marksTotal===1?"":"s"}]</span>`;

  // SECTION: Optional context block (4–5 marks only)
  // CHANGE: Show the scenario/intro ABOVE the sub-questions so answer inputs stay aligned with each question line.
  const ctxHtml = q.contextHtml ? `<div class="muted" style="margin:0 0 .85rem 0; color: var(--ink)">${q.contextHtml}</div>` : ""; // CHANGE: scenario text is black (not muted/grey)

  // SECTION: Sub-question labels
  // CHANGE: For questions with multiple parts, prefix each part with (a), (b), (c)... GCSE-style.
  const showLabels = q.parts.length > 1;

  const itemsHtml = q.parts.map((p,idx)=>{
    const inputHtml = renderInput(p.input, p.answer?.type, p.input?.id || `p${idx}`);
    const label = showLabels ? `<b>(${String.fromCharCode(97+idx)})</b> ` : "";
    return `
      <div class="item">
        <div class="line">
          <div class="qtext">${label}${p.textHtml}</div>
          <div>${inputHtml}</div>
        </div>
      </div>
    `;
  }).join("");

  preview.innerHTML = `
    <div class="qpanel">
      <div class="qhead">
        <h3>${title} ${badge}</h3>
        ${paperTagHtml(q.paperMode)}
      </div>
      <div class="qbody">
        ${ctxHtml}
        ${itemsHtml}
      </div>
    </div>
    ${teacherNotes(current)}
  `;

  initDragOrders();

  fb.style.display="none";
  fb.className="feedback";
  fb.textContent="";
}


// SECTION: Drag-and-drop ordering (integers/decimals/fractions)
// - Tiles can be dragged from the bank into drop boxes.
// - The student's order is stored as JSON in a hidden <input>.
// - Check logic reads and compares the stored order to the expected token list.
let dragState = {box:null, widget:null};
let clickPick = null;

function syncDragOrder(widget){
  if(!widget) return;
  const hidden = widget.querySelector('input[type="hidden"]');
  const drops = Array.from(widget.querySelectorAll(".dropbox"));
  const arr = drops.map(d=>d.querySelector(".dragbox")?.dataset.token ?? null);
  if(hidden) hidden.value = JSON.stringify(arr);
}

function initDragOrders(){
  if(clickPick && clickPick.classList) clickPick.classList.remove("selected");
  clickPick = null;
  preview.querySelectorAll(".drag-order").forEach(w=>syncDragOrder(w));
}

function placeDragBox(box, target){
  if(!box || !target) return;
  const widget = box.closest(".drag-order");
  if(!widget) return;
  const bank = widget.querySelector(".drag-bank");
  if(!bank) return;

  if(target.classList.contains("dropbox")){
    const existing = target.querySelector(".dragbox");
    const srcParent = box.parentElement;
    if(existing && existing!==box){
      if(srcParent && srcParent.classList.contains("dropbox")){
        srcParent.appendChild(existing);
      } else {
        bank.appendChild(existing);
      }
    }
    target.appendChild(box);
  } else if(target.classList.contains("drag-bank")){
    target.appendChild(box);
  }
  syncDragOrder(widget);
}

preview.addEventListener("dragstart", (e)=>{
  const box = e.target.closest(".dragbox");
  if(!box) return;
  const widget = box.closest(".drag-order");
  if(!widget) return;
  dragState.box = box;
  dragState.widget = widget;
  box.classList.add("dragging");
  try{
    e.dataTransfer.setData("text/plain", box.dataset.token || box.textContent || "");
    e.dataTransfer.effectAllowed = "move";
  }catch(err){}
});

preview.addEventListener("dragend", (e)=>{
  const box = e.target.closest(".dragbox");
  if(box) box.classList.remove("dragging");
  preview.querySelectorAll(".dropbox.over").forEach(el=>el.classList.remove("over"));
  dragState.box = null;
  dragState.widget = null;
});

preview.addEventListener("dragover", (e)=>{
  const target = e.target.closest(".dropbox, .drag-bank");
  if(!target) return;
  const widget = target.closest(".drag-order");
  if(!widget || widget !== dragState.widget) return;
  e.preventDefault();
  if(target.classList.contains("dropbox")) target.classList.add("over");
});

preview.addEventListener("dragleave", (e)=>{
  const target = e.target.closest(".dropbox");
  if(target) target.classList.remove("over");
});

preview.addEventListener("drop", (e)=>{
  const target = e.target.closest(".dropbox, .drag-bank");
  if(!target) return;
  const widget = target.closest(".drag-order");
  if(!widget || widget !== dragState.widget) return;
  e.preventDefault();
  target.classList.remove("over");
  if(dragState.box){
    placeDragBox(dragState.box, target);
  }
});

// Tap/click fallback (mobile): tap a box to pick it up, then tap a target.
preview.addEventListener("click", (e)=>{
  const box = e.target.closest(".dragbox");
  const widget = e.target.closest(".drag-order");
  if(box && widget){
    if(clickPick === box){
      box.classList.remove("selected");
      clickPick = null;
    } else {
      if(clickPick) clickPick.classList.remove("selected");
      clickPick = box;
      box.classList.add("selected");
    }
    return;
  }

  const target = e.target.closest(".dropbox, .drag-bank");
  if(target && clickPick){
    const w2 = target.closest(".drag-order");
    const w1 = clickPick.closest(".drag-order");
    if(w1 && w2 && w1===w2){
      placeDragBox(clickPick, target);
    }
    clickPick.classList.remove("selected");
    clickPick = null;
  }
});

/* -------------------- standard form input (EXP -> superscript) -------------------- */
const SF_SUP = {
  "0":"⁰","1":"¹","2":"²","3":"³","4":"⁴","5":"⁵","6":"⁶","7":"⁷","8":"⁸","9":"⁹",
  "-":"⁻","+":"⁺"
};
const SF_UNSUP = {
  "⁰":"0","¹":"1","²":"2","³":"3","⁴":"4","⁵":"5","⁶":"6","⁷":"7","⁸":"8","⁹":"9",
  "⁻":"-","⁺":"+"
};

function sfEscapeHtml(s){
  return String(s??"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}
function sfUnsupAll(s){
  return String(s??"").replace(/[⁰¹²³⁴⁵⁶⁷⁸⁹⁻⁺]/g, ch => (SF_UNSUP[ch] ?? ch));
}
function sfSupDigits(s){
  return String(s??"").replace(/[0-9\-\+]/g, ch => (SF_SUP[ch] ?? ch));
}

function sfToHTML(raw){
  const s0 = String(raw ?? "").trim();
  if(!s0) return "";
  const plain = sfUnsupAll(s0).replace(/\s+/g,"");

  // Display E-notation as ×10^n.
  let m = plain.match(/^([+-]?(?:\d+(?:\.\d+)?|\.\d+))[eE]([+-]?\d*)$/);
  if(m){
    const A = m[1] ?? "";
    const n = m[2] ?? "";
    return `${sfEscapeHtml(A)}<span class="mul">×</span>10<sup>${sfEscapeHtml(n || "□")}</sup>`;
  }

  // Display A×10n or A×10^n (caret optional)
  m = plain.match(/^([+-]?(?:\d+(?:\.\d+)?|\.\d+))(?:×|x|\*)10\^?([+-]?\d*)$/i);
  if(m){
    const A = m[1] ?? "";
    const n = m[2] ?? "";
    return `${sfEscapeHtml(A)}<span class="mul">×</span>10<sup>${sfEscapeHtml(n || "□")}</sup>`;
  }

  // Fallback: show as typed (still replaces × with styled ×).
  return sfEscapeHtml(s0).replace(/×/g, `<span class="mul">×</span>`);
}

function sfSyncPreview(targetId){
  const el = document.getElementById(targetId);
  const box = document.getElementById(targetId+"Box");
  if(!el || !box) return;
  box.innerHTML = sfToHTML(el.value);
}

function sfSetCaretEnd(el){
  try{
    const n = el.value.length;
    el.setSelectionRange(n, n);
  }catch(err){}
}

function sfEnsureTen(v){
  v = String(v ?? "");
  if(/(?:×|x|\*)10/.test(v)) return v;
  if(v==="" || v==="-") v = (v==="-") ? "-1" : "1";
  return v + "×10";
}

function sfGetExpPart(v){
  const m = String(v ?? "").match(/(?:×|x|\*)10(.*)$/);
  return m ? (m[1] ?? "") : "";
}

function sfToggleMantissaSign(v){
  v = String(v ?? "");
  if(v.startsWith("-")) return v.slice(1);
  return v ? "-" + v : "-";
}

function sfToggleExponentSign(v){
  v = String(v ?? "");
  const m = v.match(/^(.*?)(?:×|x|\*)10(.*)$/);
  if(!m) return sfToggleMantissaSign(v);

  const head = m[1] ?? "";
  const expRaw = m[2] ?? "";
  const expPlain = sfUnsupAll(expRaw);

  let outPlain = expPlain;
  if(outPlain.startsWith("-")) outPlain = outPlain.slice(1);
  else outPlain = "-" + outPlain.replace(/^\+/, "");

  const outSup = sfSupDigits(outPlain);
  return head + "×10" + outSup;
}

function sfBackspace(v){
  v = String(v ?? "");
  if(!v) return "";

  const last = v.slice(-1);
  if(typeof SF_UNSUP[last] !== "undefined"){
    // delete superscript digit/sign
    v = v.slice(0,-1);
    return v;
  }

  if(v.endsWith("×10")) return v.slice(0,-3);
  return v.slice(0,-1);
}

// Keep the preview in sync while typing
preview.addEventListener("input", (e)=>{
  const el = e.target;
  if(!(el instanceof HTMLInputElement)) return;
  if(!el.classList.contains("sfinput")) return;

  // If the user deletes the ×10 part, cancel EXP mode
  if(el.dataset.sfExp === "1" && !/(?:×|x|\*)10/.test(el.value)){
    el.dataset.sfExp = "0";
    const ctrl = preview.querySelector(`.sfctrl[data-sf-target="${el.id}"]`);
    const expBtn = ctrl ? ctrl.querySelector('button[data-act="exp"]') : null;
    if(expBtn){
      expBtn.classList.remove("on");
      expBtn.setAttribute("aria-pressed","false");
    }
  }

  sfSyncPreview(el.id);
});

// Keyboard typing: when EXP is ON, digits become superscripts (no E and no caret notation).
preview.addEventListener("keydown", (e)=>{
  const el = e.target;
  if(!(el instanceof HTMLInputElement)) return;
  if(!el.classList.contains("sfinput")) return;
  if(el.dataset.sfExp !== "1") return;

  const key = e.key;

  // Always keep typing at the end while EXP is on
  if(key==="ArrowLeft" || key==="ArrowRight" || key==="Home" || key==="End"){
    e.preventDefault();
    sfSetCaretEnd(el);
    return;
  }

  if(key==="Backspace"){
    e.preventDefault();
    const nv = sfBackspace(el.value);
    el.value = nv;
    sfSyncPreview(el.id);
    sfSetCaretEnd(el);

    // If we removed the ×10 part, also turn EXP off
    if(!/(?:×|x|\*)10/.test(el.value)){
      el.dataset.sfExp = "0";
      const ctrl = preview.querySelector(`.sfctrl[data-sf-target="${el.id}"]`);
      const expBtn = ctrl ? ctrl.querySelector('button[data-act="exp"]') : null;
      if(expBtn){
        expBtn.classList.remove("on");
        expBtn.setAttribute("aria-pressed","false");
      }
    }
    return;
  }

  if(/^[0-9]$/.test(key) || key==="-" || key==="+"){
    e.preventDefault();
    let v = sfEnsureTen(el.value);

    const expRaw = sfGetExpPart(v);
    const expPlain = sfUnsupAll(expRaw);

    // Only allow +/− as the FIRST exponent character
    if((key==="-" || key==="+") && expPlain.length>0) return;

    v += SF_SUP[key] ?? key;
    el.value = v;
    sfSyncPreview(el.id);
    sfSetCaretEnd(el);
    return;
  }
});

// Buttons (EXP / ± / ⌫ / Clear)
preview.addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  const ctrl = btn.closest(".sfctrl");
  if(!ctrl) return;

  e.preventDefault();

  const targetId = ctrl.dataset.sfTarget;
  const el = document.getElementById(targetId);
  if(!el) return;

  const act = btn.dataset.act;

  if(act==="clear"){
    el.value = "";
    el.dataset.sfExp = "0";
    btn.classList.remove("on");
    btn.setAttribute("aria-pressed","false");
    sfSyncPreview(targetId);
    el.focus();
    return;
  }

  if(act==="bksp"){
    const nv = sfBackspace(el.value);
    el.value = nv;
    sfSyncPreview(targetId);
    sfSetCaretEnd(el);

    if(!/(?:×|x|\*)10/.test(el.value)){
      el.dataset.sfExp = "0";
      const expBtn = ctrl.querySelector('button[data-act="exp"]');
      if(expBtn){
        expBtn.classList.remove("on");
        expBtn.setAttribute("aria-pressed","false");
      }
    }

    el.focus();
    return;
  }

  if(act==="exp"){
    const expBtn = ctrl.querySelector('button[data-act="exp"]');
    const on = !(el.dataset.sfExp === "1");
    el.dataset.sfExp = on ? "1" : "0";
    if(expBtn){
      expBtn.classList.toggle("on", on);
      expBtn.setAttribute("aria-pressed", on ? "true" : "false");
    }

    if(on){
      el.value = sfEnsureTen(el.value);
      // Do NOT insert ^ or E. Exponent digits will be added as superscripts.
      sfSetCaretEnd(el);
    }

    sfSyncPreview(targetId);
    el.focus();
    return;
  }

  if(act==="neg"){
    // If there is a ×10 part, toggle the exponent sign. Otherwise toggle the mantissa sign.
    if(/(?:×|x|\*)10/.test(el.value)){
      el.value = sfToggleExponentSign(el.value);
    }else{
      el.value = sfToggleMantissaSign(el.value);
    }
    sfSyncPreview(targetId);
    sfSetCaretEnd(el);
    el.focus();
    return;
  }
});

/* -------------------- keypad for prime factors (exp / × / primes) -------------------- */
function pfToHTML(expr){
  if(!expr) return "";
  const parts = String(expr).split("×");
  let out = "";
  for(let i=0;i<parts.length;i++){
    const tok = parts[i];
    if(tok){
      if(tok.includes("^")){
        const [base, exp] = tok.split("^");
        out += `${base}<sup>${exp||""}</sup>`;
      }else{
        out += tok;
      }
    }
    if(i < parts.length-1){
      out += `<span class="mul">×</span>`;
    }
  }
  return out;
}

function pfSetValue(targetId, newVal){
  const hidden = document.getElementById(targetId);
  const box = document.getElementById(targetId+"Box");
  if(!hidden || !box) return;
  hidden.value = newVal;
  box.innerHTML = pfToHTML(newVal);
}

function pfBackspace(expr){
  if(!expr) return "";
  let s = String(expr);
  if(s.endsWith("×")) return s.slice(0,-1);

  const parts = s.split("×");
  if(parts.length===0) return "";
  let last = parts[parts.length-1] || "";

  if(last.includes("^")){
    let [base, exp] = last.split("^");
    exp = exp || "";
    if(exp.length<=1){
      last = base;
    }else{
      last = base + "^" + exp.slice(0,-1);
    }
    parts[parts.length-1] = last;
    return parts.join("×");
  }

  last = last.slice(0,-1);
  if(last===""){
    parts.pop();
    return parts.join("×");
  }
  parts[parts.length-1] = last;
  return parts.join("×");
}

preview.addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  const pad = btn.closest(".keypad");
  if(!pad) return;

  e.preventDefault();

  const target = pad.dataset.target;
  const hidden = document.getElementById(target);
  const box = document.getElementById(target+"Box");
  if(!hidden || !box) return;

  const expBtn = pad.querySelector('button[data-act="exp"]');
  const setExp = (on)=>{
    pad.dataset.exp = on ? "1" : "0";
    if(expBtn){
      expBtn.classList.toggle("on", on);
      expBtn.setAttribute("aria-pressed", on ? "true" : "false");
    }
  };

  const isExp = pad.dataset.exp === "1";
  let val = hidden.value || "";

  const act = btn.dataset.act;
  const prime = btn.dataset.prime;
  const digit = btn.dataset.digit;
  const ins = btn.dataset.ins;

  if(act==="clear"){
    pfSetValue(target, "");
    setExp(false);
    return;
  }
  if(act==="bksp"){
    const nv = pfBackspace(val);
    pfSetValue(target, nv);
    // keep exp mode as-is
    return;
  }
  if(act==="exp"){
    if(!val || val.endsWith("×")){ setExp(false); return; }
    setExp(!isExp);
    return;
  }

  if(ins==="×"){
    setExp(false);
    if(!val) return;
    if(val.endsWith("×")) return;
    pfSetValue(target, val + "×");
    return;
  }

  if(prime){
    setExp(false);
    if(val && !val.endsWith("×")) val += "×";
    pfSetValue(target, val + prime);
    return;
  }

  if(typeof digit !== "undefined"){
    if(pad.dataset.exp !== "1") return;
    if(!val || val.endsWith("×")) return;

    const parts = val.split("×");
    let last = parts[parts.length-1] || "";
    if(!last) return;

    let base = last, exp = "";
    if(last.includes("^")){
      [base, exp] = last.split("^");
      exp = exp || "";
    }
    if(exp==="" && digit==="0") return; // no leading zero exponent
    exp += digit;
    parts[parts.length-1] = base + "^" + exp;
    pfSetValue(target, parts.join("×"));
    return;
  }
});

/* -------------------- Answer retrieval -------------------- */
function clearMarks(){
  // remove ok/bad classes from inputs + drag-order tiles
  preview.querySelectorAll("input,select,.dropbox,.dragbox").forEach(el=>{
    el.classList.remove("ok","bad");
  });
}
function markEl(el, ok){
  if(!el) return;
  el.classList.remove("ok","bad");
  el.classList.add(ok ? "ok" : "bad");
}
function getUserAnswerForPart(part){
  const id = part.input?.id;
  const type = part.answer?.type;

  if (part.input?.kind==="order" || type==="order"){
    const hidden = document.getElementById(id);
    const widget = preview.querySelector(`.drag-order[data-drag-order="${id}"]`);
    const drops = widget ? Array.from(widget.querySelectorAll(".dropbox")) : [];

    let arr = null;
    if(hidden && hidden.value){
      try{ arr = JSON.parse(hidden.value); }catch{ arr = null; }
    }
    if(!Array.isArray(arr) && drops.length){
      arr = drops.map(d=>d.querySelector(".dragbox")?.dataset.token ?? null);
    }
    if(!Array.isArray(arr)){
      return {ok:false, val:null, els:drops.length?drops:[hidden].filter(Boolean)};
    }

    const filled = arr.every(x=>x!==null && x!=="" && typeof x!=="undefined");
    return {ok:filled, val:arr, els:drops.length?drops:[hidden].filter(Boolean)};
  }

  if (part.input?.kind==="fraction" || type==="fraction"){
    const nEl = document.getElementById(id+"N");
    const dEl = document.getElementById(id+"D");
    const n = Number(nEl?.value);
    const d = Number(dEl?.value);
    if(!Number.isFinite(n)||!Number.isFinite(d)||d===0) return {ok:false, val:null, els:[nEl,dEl]};
    return {ok:true, val:{n, d}, els:[nEl,dEl]};
  }

  if (part.input?.kind==="pair" || type==="pair"){
    const aEl = document.getElementById(id+"A");
    const bEl = document.getElementById(id+"B");
    const a = asNum(aEl?.value);
    const b = asNum(bEl?.value);
    if(!Number.isFinite(a)||!Number.isFinite(b)) return {ok:false, val:null, els:[aEl,bEl]};
    return {ok:true, val:[a,b], els:[aEl,bEl]};
  }

  if (part.input?.kind==="standardForm" || type==="standardForm"){
    const el = document.getElementById(id);
    const parsed = parseStandardFormInput(el?.value);
    if(!parsed.ok || !Number.isFinite(parsed.A) || !Number.isFinite(parsed.n)) return {ok:false, val:null, els:[el]};
    return {ok:true, val:{A: parsed.A, n: parsed.n}, els:[el]};
  }

  if (part.input?.kind==="primeFactors" || type==="primeFactors"){
    const el = document.getElementById(id);
    const raw = (el?.value ?? "").trim();
    if(!raw) return {ok:false, val:null, els:[el]};
    return {ok:true, val:raw, els:[el]};
  }

  if (part.input?.kind==="symbol" || type==="symbol"){
    const el = document.getElementById(id);
    const v = (el?.value ?? "").trim();
    if(!v) return {ok:false, val:null, els:[el]};
    return {ok:true, val:v, els:[el]};
  }

  if (part.input?.kind==="time" || type==="time"){
    const el = document.getElementById(id);
    const v = (el?.value ?? "").trim();
    if(!v) return {ok:false, val:null, els:[el]};
    return {ok:true, val:v, els:[el]};
  }

  if (part.input?.kind==="integer"){
    const el = document.getElementById(id);
    const x = asNum(el?.value);
    if(!Number.isFinite(x) || !Number.isInteger(x)) return {ok:false, val:null, els:[el]};
    return {ok:true, val:x, els:[el]};
  }

  const el = document.getElementById(id);
  const x = asNum(el?.value);
  if(!Number.isFinite(x)) return {ok:false, val:null, els:[el]};
  return {ok:true, val:x, els:[el]};
}



/* -------------------- prime-factor answer parsing -------------------- */
function parsePrimeFactorString(raw){
  // Accept forms like: 2^3×3×5^2  or 2*2*2*3*25 etc
  // Reject plain "2475" with no × or ^ (not a factorisation).
  const s = raw.replace(/\s+/g,"")
               .replace(/x/gi,"×")
               .replace(/\*/g,"×")
               .replace(/\./g,"×"); // allow dot as multiply
  const hasSep = s.includes("×") || s.includes("^");
  if(!hasSep) return {ok:false, map:null};

  const parts = s.split("×").filter(Boolean);
  if(parts.length===0) return {ok:false, map:null};

  const map = {};
  for(const tok of parts){
    if(tok==="1" || tok==="+1") return {ok:false, map:null}; // disallow 1 as factor
    // exponent form p^e
    if(tok.includes("^")){
      const m = tok.match(/^(\d+)\^(\d+)$/);
      if(!m) return {ok:false, map:null};
      const p = Number(m[1]), e = Number(m[2]);
      if(!(Number.isInteger(p)&&Number.isInteger(e)&&p>=2&&e>=1)) return {ok:false, map:null};
      const f = factorise(p);
      // base should be prime ideally; but allow composite base (we factor it)
      for(const k of Object.keys(f)){
        map[k] = (map[k]||0) + f[k]*e;
      }
    } else {
      // integer factor (prime or composite)
      const v = Number(tok);
      if(!Number.isInteger(v) || v<2) return {ok:false, map:null};
      const f = factorise(v);
      for(const k of Object.keys(f)){
        map[k] = (map[k]||0) + f[k];
      }
    }
  }
  return {ok:true, map};
}

/* -------------------- marking -------------------- */
function markCurrent(){
  if(!current) return;

  clearMarks();

  let score = 0;
  let max = current.marksTotal;

  for(const part of current.parts){
    const expected = part.answer;
    const got = getUserAnswerForPart(part);
    const pm = part.marks ?? 0;

    // Drag-order marking (2 marks in the higher-order questions).
    if(expected && expected.type==="order"){
      const correct = Array.isArray(expected.value) ? expected.value : [];
      const user = Array.isArray(got.val) ? got.val : [];
      let partScore = 0;

      if(user.length === correct.length && got.els && got.els.length){
        let correctCount = 0;

        got.els.forEach((el,i)=>{
          const posOk = Boolean(got.ok) && (user[i] === correct[i]);
          if(posOk) correctCount++;
          markEl(el, posOk);
        });

        if(Boolean(got.ok) && correctCount === correct.length){
          partScore = pm;
        } else if(Boolean(got.ok) && pm>=2 && correctCount >= Math.ceil(correct.length/2)){
          partScore = 1; // partial credit
        } else {
          partScore = 0;
        }
      } else {
        if(got.els && got.els.length) got.els.forEach(el=>markEl(el,false));
        partScore = 0;
      }

      score += partScore;
      continue;
    }

    let ok = false;

    if(!got.ok){
      ok = false;
    } else if(expected.type==="fraction"){
      ok = fracEq(got.val, expected.value);
    } else if(expected.type==="pair"){
      ok = close(got.val[0], expected.value[0], 1e-6) && close(got.val[1], expected.value[1], 1e-6);
    } else if(expected.type==="standardForm"){
      // require standard form: 1 ≤ A < 10 and integer n
      const A = got.val.A;
      const n = got.val.n;
      const userVal = A * (10**n);
      const targetVal = expected.value;
      ok = Number.isFinite(userVal) && Number.isFinite(A) && Number.isInteger(n) && A>=1 && A<10 &&
           close(userVal, targetVal, Math.max(1e-9, Math.abs(targetVal)*1e-8));
    } else if(expected.type==="primeFactors"){
      const parsed = parsePrimeFactorString(got.val);
      ok = parsed.ok && mapsEqual(parsed.map, expected.value);
    } else if(expected.type==="symbol"){
      ok = got.val === expected.value;
    } else if(expected.type==="time"){
      ok = String(got.val).trim() === String(expected.value).trim();
    } else {
      // number
      ok = close(got.val, expected.value, Math.max(1e-9, Math.abs(expected.value)*1e-8));
    }

    // Mark UI elements
    if(got.els && got.els.length){
      got.els.forEach(el=>markEl(el, ok));
    }

    if(ok) score += pm;
  }

  fb.style.display="block";
  fb.className = "feedback " + (score===max ? "good" : (score>0 ? "" : "bad"));
  fb.innerHTML = `<b>Score:</b> ${score} / ${max}`;
}



function revealCurrent(){
  if(!current) return;
  const fb = document.getElementById("fb");
  if(!fb) return;
  fb.style.display = "block";

  const formatStd = (v)=>{
    const num = Number(v);
    if(!isFinite(num)) return String(v);
    if(num===0) return "0"; // avoid 10^0
    const sign = num<0 ? "−" : "";
    const abs = Math.abs(num);
    const n = Math.floor(Math.log10(abs));
    if(n===0) return sign + fmt(abs,4); // avoid 10^0
    const A = abs / Math.pow(10,n);
    return `${sign}${fmt(A,4)} × 10<sup>${n}</sup>`;
  };

  const formatPF = (map)=>{
    const parts = Object.entries(map)
      .sort((a,b)=>Number(a[0])-Number(b[0]))
      .map(([p,e])=>{
        const ee = Number(e);
        return ee===1 ? `${p}` : `${p}<sup>${ee}</sup>`;
      });
    return parts.join(" × ");
  };

  const answers = current.parts.map(p=>{
    const ex = p.answer;
    if(!ex) return "";
    if(ex.type==="fraction"){
      return mfrac(ex.value.n, ex.value.d);
    }
    if(ex.type==="order"){
      const tok=(t)=>{const s=String(t);const m=s.match(/^(-?\d+)\s*\/\s*(\d+)$/);return m?mfrac(parseInt(m[1],10),parseInt(m[2],10)):s;};
      return ex.value.map(tok).join(", ");
    }
    if(ex.type==="pair"){
      return `(${ex.value[0]}, ${ex.value[1]})`;
    }
    if(ex.type==="primeFactors"){
      return formatPF(ex.value);
    }
    if(ex.type==="standardForm"){
      return formatStd(ex.value);
    }
    if(ex.type==="time"){
      return String(ex.value);
    }
    if(p.input && p.input.kind==="money"){
      return "£" + fmt(Number(ex.value), 2);
    }
    return String(ex.value);
  });

  fb.innerHTML = `
    <div style="margin-top:10px">
      <b>Answers:</b>
      <ol style="margin:8px 0 0 18px">
        ${answers.map(a=>`<li>${a}</li>`).join("")}
      </ol>
    </div>
    ${teacherNotes(current)}
  `;
}




function teacherNotes(q){
  // SECTION: Teacher notes (REMOVED)
  // CHANGE: Teacher notes must not appear anywhere in the student prototype.
  // This stub preserves the call sites without changing other rendering logic.
  return "";
}

function generateNew(){
  const topic = topicSel.value;
  const marks = Number(marksSel.value);
  const paperMode = calcSel.value;

  const rng = makeRng(cryptoSeed());
  let q = buildQuestion(topic, marks, paperMode, rng);

  // Patch: N11(3) placeholder fix if needed
  if(q.topicCode==="N11" && q.marksTotal===3){
    // we generated a placeholder null; replace with a consistent y equation
    const xAns = q.parts[0].answer.value;
    const k = Math.floor(Math.random()*19)+2; // 2..20, OK for patch only
    q.parts[1].textHtml = `Now find <b>y</b>: <b>y − ${xAns} = ${k}</b>. <span class="endmark">[1]</span>`;
    q.parts[1].answer.value = xAns + k;
  }

  // Safety: ensure marks sum
  const sum = q.parts.reduce((s,p)=>s+(p.marks||0),0);
  if(sum !== q.marksTotal){
    console.warn("Marks mismatch; adjusting", {sum, expected:q.marksTotal});
    // force 1 mark each then remainder on last
    const parts = q.parts.map(p=>({...p, marks:1}));
    const remainder = q.marksTotal - parts.length;
    if(remainder>0) parts[parts.length-1].marks += remainder;
    q.parts = parts;
  }

  current = q;
  renderQuestion(q);
}

regenBtn.addEventListener("click", generateNew);
checkBtn.addEventListener("click", markCurrent);
revealBtn.addEventListener("click", revealCurrent);
topicSel.addEventListener("change", generateNew);
marksSel.addEventListener("change", generateNew);
calcSel.addEventListener("change", generateNew);

/* -------------------- init -------------------- */
initTopicDropdown();
generateNew();
</script>
</body>
</html>
